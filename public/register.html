<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register</title>
    <link rel="stylesheet" href="./style.css">
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0/dist/iife/sdk.js"></script>
</head>
<body class="register-page">
<div class="register-container">
    <h1>Create New Account</h1>
    <div class="info-note">
        <strong>Note:</strong> All new registrations are assigned staff role by default. Admins can change your role later.
    </div>

    <form id="registerForm">
        <div class="form-group">
            <label for="username">Username <span class="required">*</span></label>
            <div class="input-icon">
                <input type="text" id="username" name="username" required placeholder="Enter your username">
                <span class="icon" id="usernameIcon"></span>
            </div>
            <div class="field-validation" id="usernameValidation"></div>
        </div>

        <div class="form-group">
            <label for="email">Email <span class="required">*</span></label>
            <div class="input-icon">
                <input type="email" id="email" name="email" required placeholder="Enter your email">
                <span class="icon" id="emailIcon"></span>
            </div>
            <div class="field-validation" id="emailValidation"></div>
        </div>

        <div class="form-group">
            <label for="password">Password <span class="required">*</span></label>
            <div class="input-icon">
                <input type="password" id="password" name="password" required placeholder="Enter your password">
                <span class="icon" id="passwordIcon"></span>
            </div>
            <div class="password-strength" id="passwordStrength"></div>
            <div class="field-validation" id="passwordValidation"></div>
        </div>

        <div class="form-group">
            <label for="confirmPassword">Confirm Password <span class="required">*</span></label>
            <div class="input-icon">
                <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Re-enter your password">
                <span class="icon" id="confirmPasswordIcon"></span>
            </div>
            <div class="field-validation" id="confirmPasswordValidation"></div>
        </div>

        <button type="submit" class="register-btn" id="registerBtn">Create Account</button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Creating your account...</p>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
    </form>

    <div class="login-link">
        <p>Already have an account? <a href="index.html">Login here</a></p>
    </div>
</div>

<script>
const { Client, Account, Databases, ID } = window.Appwrite;
const client = new Client();
client.setEndpoint("https://fra.cloud.appwrite.io/v1").setProject("68ddd7de00255d4f5c96");

const account = new Account(client);
const database = new Databases(client);
const databaseId = "68ba8a9c001f17064e15";   
const collectionId = "68ba8c240002116fa647"; 

const registerForm = document.getElementById('registerForm');
const registerBtn = document.getElementById('registerBtn');
const loading = document.getElementById('loading');
const errorMessage = document.getElementById('errorMessage');
const successMessage = document.getElementById('successMessage');

let validationStates = { username: false, email: false, password: false, confirmPassword: false };

document.getElementById('username').addEventListener('input', validateUsername);
document.getElementById('email').addEventListener('input', validateEmail);
document.getElementById('password').addEventListener('input', validatePassword);
document.getElementById('confirmPassword').addEventListener('input', validateConfirmPassword);

registerForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    validateUsername();
    validateEmail();
    validatePassword();
    validateConfirmPassword();

    if (!Object.values(validationStates).every(Boolean)) {
        showError('Please fix all validation errors before submitting.');
        return;
    }

    const formData = {
        username: document.getElementById('username').value.trim(),
        email: document.getElementById('email').value.trim(),
        password: document.getElementById('password').value
    };

    showLoading(true);
    hideMessages();

    try {
        console.log('Creating account for:', formData.email);
        const user = await account.create(
            ID.unique(),
            formData.email,
            formData.password,
            formData.username
        );
        console.log('Account created:', user);

        try {
            await database.createDocument(
                databaseId,
                collectionId,
                user.$id,
                {
                    username: formData.username,
                    email: formData.email,
                    role: 'staff',
                    status: 'approved',
                    registerDate: new Date().toISOString()
                }
            );
            console.log("User profile created in users collection with approved status");
        } catch (dbError) {
            console.error("Failed to insert user into users collection:", dbError);
            showError("Account created, but failed to create profile in database. Contact admin.");
            showLoading(false);
            return;
        }

        showSuccess('Account created successfully! You can now login with your credentials.');
        registerForm.reset();
        resetValidationStates();

        setTimeout(() => {
            window.location.href = 'index.html';
        }, 2000);

    } catch (error) {
        console.error('Registration failed:', error);
        let errorMsg;
        if (error.code === 409) {
            errorMsg = "An account with this email already exists. Please login or use a different email.";
        } else if (error.message.includes('Invalid email')) {
            errorMsg = "Please enter a valid email address.";
        } else if (error.message.includes('Password')) {
            errorMsg = "Password must be at least 8 characters long.";
        } else if (error.code === 400) {
            errorMsg = "Invalid input. Please check your information and try again.";
        } else {
            errorMsg = `Registration failed: ${error.message}`;
        }
        showError(errorMsg);
    } finally {
        showLoading(false);
    }
});

function validateUsername() {
    const username = document.getElementById('username').value.trim();
    const validation = document.getElementById('usernameValidation');
    if (username.length < 3) {
        validation.textContent = 'Username must be at least 3 characters.';
        validation.style.color = '#e74c3c';
        validationStates.username = false;
    } else {
        validation.textContent = '';
        validationStates.username = true;
    }
    updateSubmitButton();
}

function validateEmail() {
    const email = document.getElementById('email').value.trim();
    const validation = document.getElementById('emailValidation');
    const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!regex.test(email)) {
        validation.textContent = 'Enter a valid email address.';
        validation.style.color = '#e74c3c';
        validationStates.email = false;
    } else {
        validation.textContent = '';
        validationStates.email = true;
    }
    updateSubmitButton();
}

function validatePassword() {
    const password = document.getElementById('password').value;
    const validation = document.getElementById('passwordValidation');
    const strengthIndicator = document.getElementById('passwordStrength');

    if (password.length < 8) {
        validation.textContent = 'Password must be at least 8 characters.';
        validation.style.color = '#e74c3c';
        strengthIndicator.textContent = '';
        validationStates.password = false;
    } else {
        validation.textContent = '';
        if (password.length >= 12) {
            strengthIndicator.textContent = 'Password strength: Very Strong';
            strengthIndicator.style.color = '#27ae60';
        } else if (password.length >= 10) {
            strengthIndicator.textContent = 'Password strength: Strong';
            strengthIndicator.style.color = '#2ecc71';
        } else {
            strengthIndicator.textContent = 'Password strength: Good';
            strengthIndicator.style.color = '#f39c12';
        }
        validationStates.password = true;
    }
    validateConfirmPassword();
    updateSubmitButton();
}

function validateConfirmPassword() {
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const validation = document.getElementById('confirmPasswordValidation');

    if (confirmPassword === '') {
        validation.textContent = '';
        validationStates.confirmPassword = false;
    } else if (confirmPassword !== password) {
        validation.textContent = 'Passwords do not match.';
        validation.style.color = '#e74c3c';
        validationStates.confirmPassword = false;
    } else {
        validation.textContent = '';
        validationStates.confirmPassword = true;
    }
    updateSubmitButton();
}

function updateSubmitButton() {
    const allValid = Object.values(validationStates).every(Boolean);
    registerBtn.disabled = !allValid;
    registerBtn.style.opacity = allValid ? '1' : '0.6';
}

function resetValidationStates() {
    validationStates = { username: false, email: false, password: false, confirmPassword: false };
    document.querySelectorAll('.field-validation').forEach(el => el.textContent = '');
    document.getElementById('passwordStrength').textContent = '';
    updateSubmitButton();
}

function showLoading(show) {
    loading.style.display = show ? 'block' : 'none';
    registerBtn.disabled = show;
}

function showError(message) {
    errorMessage.textContent = message;
    errorMessage.style.display = 'block';
    successMessage.style.display = 'none';
}

function showSuccess(message) {
    successMessage.textContent = message;
    successMessage.style.display = 'block';
    errorMessage.style.display = 'none';
}

function hideMessages() {
    errorMessage.style.display = 'none';
    successMessage.style.display = 'none';
}
</script>

<footer class="footer-regis">
    <span>© 2025 ViTrox. All rights reserved.</span>
</footer>

</body>
</html>
