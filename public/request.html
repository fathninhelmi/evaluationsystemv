<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Requested Form</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="./style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0/dist/iife/sdk.js"></script>
</head>
<body>
<header class="header">
    <a href="#" class="logo"><img src="logo.png" alt="logo"></a>
    <nav class="nav-desktop">
        <a href="https://docs.google.com/spreadsheets/d/1mxleL8_nFfu6T9RpWAq-7V5K6YX8WRI_d3_uo0bd6Cc/edit?usp=sharing" class="nav-link active" target="_blank">Feedback</a>
        <a href="/manager.html" class="nav-link">Home</a>
        <a href="/spreadsheet.html" class="nav-link">Spreadsheet</a>
        <a href="/request.html" class="nav-link active">Requested Form</a>
        <a href="#" id="logoutBtn" class="nav-link">Logout</a>
    </nav>
</header>

<div class="req-contain">
  <h1>Requested Form List</h1>
  <div class="reqcontainer" id="requestContainer"></div>
</div>

<script>
const { Client, Account, Databases, Query } = window.Appwrite;
const client = new Client();
client.setEndpoint("https://fra.cloud.appwrite.io/v1").setProject("68ddd7de00255d4f5c96");

const databases = new Databases(client);
const account = new Account(client);

const databaseId = "68ba8a9c001f17064e15";
const requestListId = "68db7c5d000007c7fd7e";
const collectionId = "68ba918c0022d2b9a429";
const preEvalCollectionIds = {
  'AOI': '68c7ced6001bd14d08f4',
  'SPI': '696dd2b1000c4e985d76',
  'AXI': '696ed4b900377582df31',
  'ARV': '696dd29b0034536c09b9', 
  'XC': '696dd2f20006c0eef2a1',  
  'XS': '696dd301001cd0f6da66'  
};
const evalCollectionId    = "68bf9d5600257a20775a";
const postEvalCollectionId= "68bf9d62002b4f5f7f23";
const usersCollectionId = "68ba8c240002116fa647";
const requestContainer = document.getElementById('requestContainer');

async function checkSession() {
    try {
        const user = await account.get();
        return user;
    } catch (err) {
        console.error('Session check error:', err);
        window.location.href = '/index.html';
    }
}

document.getElementById("logoutBtn").addEventListener("click", async () => {
    try {
        await account.deleteSession('current');
        window.location.href = "/index.html";
    } catch {
        window.location.href = "/index.html";
    }
});

async function loadRequests() {
    try {
        const res = await databases.listDocuments(databaseId, requestListId);
        const allRequests = [];
        for (const doc of res.documents) {
            let formLocation = '';
            let formattedStartDate = 'N/A';
            let formattedEndDate = 'N/A';
            let productType = 'AOI'; // Default
            
            // First, get the main form to get the product type
            try {
                const mainFormDoc = await databases.getDocument(databaseId, collectionId, doc.formId);
                productType = mainFormDoc.productType || 'AOI';
            } catch (err) {
                console.warn(`Could not fetch main form ${doc.formId}:`, err);
            }
            
            // Get the correct pre-eval collection ID based on product type
            const preEvalCollectionId = preEvalCollectionIds[productType] || preEvalCollectionIds['AOI'];
            
            // Now fetch the pre-eval form to get the dates
            try {
                const preEvalDoc = await databases.getDocument(databaseId, preEvalCollectionId, doc.formId);
                
                if (preEvalDoc.evalStartDate) {
                    const date = new Date(preEvalDoc.evalStartDate);
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = String(date.getFullYear()).slice(-2);
                    formattedStartDate = `${day}/${month}/${year}`;
                }
                
                if (preEvalDoc.endEstimateDate) {
                    const date = new Date(preEvalDoc.endEstimateDate);
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = String(date.getFullYear()).slice(-2);
                    formattedEndDate = `${day}/${month}/${year}`;
                }
            } catch (err) {
                console.warn(`Could not fetch pre-eval form ${doc.formId}:`, err);
            }
            
            // Get location from post-eval or main form
            try {
                const formDoc = await databases.getDocument(databaseId, postEvalCollectionId, doc.formId);
                formLocation = formDoc.customerLocation || '';
            } catch (err) {
                console.warn(`Could not fetch location for form ${doc.formId}:`, err);
            }
            
            allRequests.push({
                id: doc.$id,
                formId: doc.formId,
                username: doc.username || 'Unknown User',
                prodname: doc.prodname || 'Untitled',
                customerCompany: doc.customerCompany || 'N/A',
                evalStartDate: formattedStartDate,
                endEstimateDate: formattedEndDate,
                statusReq: doc.statusReq || 'pending',
                location: formLocation
            });
        }

        renderRequests(allRequests);
    } catch (err) {
        console.error('Error loading requests:', err);
        requestContainer.innerHTML = '<p style="text-align:center; padding:20px;">Error loading requests</p>';
    }
}

function renderRequests(requests) {
    requestContainer.innerHTML = '';
    if (requests.length === 0) {
        requestContainer.innerHTML = '<p style="text-align:center; padding:20px;">No pending requests</p>';
        return;
    }

    requests.forEach(request => {
        const item = document.createElement('div');
        item.className = 'request-item';
        
        let actionButtons = '';
        if (request.statusReq === 'approved') {
            actionButtons = `
                <button class="status-badge approved" disabled style="cursor: not-allowed; opacity: 0.7;">
                    <i class="fas fa-check"></i> Approved
                </button>
            `;
        } else if (request.statusReq === 'rejected') {
            actionButtons = `
                <button class="status-badge rejected" disabled style="cursor: not-allowed; opacity: 0.7;">
                    <i class="fas fa-times"></i> Rejected
                </button>
            `;
        } else {
            actionButtons = `
                <button class="status-badge approved" onclick="approveRequest('${request.id}')">
                    <i class="fas fa-check"></i>
                </button>
                <button class="status-badge rejected" onclick="declineRequest('${request.id}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
        }
        
        const locationBadge = request.location 
            ? `<span style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 3px; font-size: 12px; margin-left: 8px;">
                <i class="fas fa-map-marker-alt"></i> ${request.location}
               </span>`
            : '';
        
        item.innerHTML = `
            <div class="user-info">
                <strong>${request.username}</strong> has requested 
                <a href="#" onclick="viewRequestedForm('${request.formId}'); return false;" 
                   style="color: #007bff; text-decoration: underline; cursor: pointer; font-weight: 500;">
                    ${request.prodname}
                </a>, ${request.customerCompany} (Start: ${request.evalStartDate} - End: ${request.endEstimateDate})
                ${locationBadge}
            </div>
            <div class="actions">
                ${actionButtons}
            </div>
        `;
        requestContainer.appendChild(item);
    });
}

async function viewRequestedForm(formId) {
    window.location.href = `posteval.html?id=${formId}&mode=view&showNavigation=true`;
}

async function approveRequest(id) {
    try {
        const currentDoc = await databases.getDocument(databaseId, requestListId, id);

        await databases.updateDocument(databaseId, requestListId, id, {
            statusReq: 'approved',
            evalStartDate: currentDoc.evalStartDate,
            endEstimateDate: currentDoc.endEstimateDate
        });
        
        alert('Request approved successfully!');
        loadRequests();
    } catch (err) {
        console.error('Error approving request:', err);
        console.error('Full error:', err.message);
        alert(`Failed to approve request: ${err.message}`);
    }
}

async function declineRequest(id) {
    try {
        const currentDoc = await databases.getDocument(databaseId, requestListId, id);
        
        await databases.updateDocument(databaseId, requestListId, id, {
            statusReq: 'rejected',
            evalStartDate: currentDoc.evalStartDate,
            endEstimateDate: currentDoc.endEstimateDate
        });
        
        alert('Request rejected.');
        loadRequests();
    } catch (err) {
        console.error('Error rejecting request:', err);
        console.error('Full error:', err.message);
        alert(`Failed to reject request: ${err.message}`);
    }
}

(async function init() {
    await checkSession();
    await loadRequests();
})();
</script>

<footer class="footer-regis">
  <span>Â© 2025 ViTrox. All rights reserved.</span>
</footer>
</body>
</html>

