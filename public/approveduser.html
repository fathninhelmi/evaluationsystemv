<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Management</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="./style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0/dist/iife/sdk.js"></script>
</head>
<body>
<header class="header">
    <a href="#" class="logo"><img src="logo.png" alt="logo"></a>
    <nav class="nav-desktop">
        <a href="approveduser.html" class="nav-link active">User Management</a>
        <a href="manageform.html" class="nav-link">Manage Forms</a>
        <a href="referencecust.html" class="nav-link">References Details</a>
        <a href="#" class="nav-link" id="logoutBtn">Logout</a>
    </nav>
</header>

<main class="main-content-ad">
    <h1>Welcome, Admin</h1>
    <div class="container-ad">
        <div class="controls-bar">
            <div class="search-filters">
                <div class="search-input">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search users by username or email" onkeyup="filterUsers()">
                </div>
                <div class="filter-group">
                    <select id="roleFilter" onchange="filterUsers()" class="filter-select">
                        <option value="all">All Roles</option>
                        <option value="staff">Staff</option>
                        <option value="manager">Manager</option>
                        <option value="admin">Admin</option>
                    </select>
                    <select id="regionFilter" onchange="filterUsers()" class="filter-select">
                        <option value="all">All Regions</option>
                        <option value="SEA">SEA</option>
                        <option value="ChinaKorJap">China/Korea/Japan</option>
                        <option value="EuropeMdiEastAfrica">Europe/Middle East/Africa</option>
                        <option value="USMexBrazil">US/Mexico/Brazil</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="stats-grid-ad">
            <div class="stat-card-ad">
                <div class="stat-icon-ad approved">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label-ad">Total Users</div>
                </div>
            </div>
            <div class="stat-card-ad">
                <div class="stat-icon-ad pending">
                    <i class="fas fa-user-tie"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" id="staffCount">0</div>
                    <div class="stat-label-ad">Staff</div>
                </div>
            </div>
            <div class="stat-card-ad">
                <div class="stat-icon-ad">
                    <i class="fas fa-user-cog"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" id="managerCount">0</div>
                    <div class="stat-label-ad">Managers</div>
                </div>
            </div>
            <div class="stat-card-ad">
                <div class="stat-icon-ad rejected">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" id="adminCount">0</div>
                    <div class="stat-label-ad">Admins</div>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table class="users-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                        <th onclick="sortTable('name')" style="cursor: pointer;">
                            Username <i class="fas fa-sort"></i>
                        </th>
                        <th onclick="sortTable('email')" style="cursor: pointer;">
                            Email <i class="fas fa-sort"></i>
                        </th>
                        <th>Role</th>
                        <th onclick="sortTable('registrationDate')" style="cursor: pointer;">
                            Registration Date <i class="fas fa-sort"></i>
                        </th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody"></tbody>
            </table>

            <div id="emptyState" class="empty-state" style="display: none;">
                <i class="fas fa-users"></i>
                <h3>No users found</h3>
                <p>Try adjusting your search criteria or filters.</p>
            </div>

            <div class="pagination" id="pagination" style="display: none;">
                <button class="btn-pagination" onclick="firstPage()" id="firstBtn">
                    <i class="fas fa-angle-double-left"></i>
                </button>
                <button class="btn-pagination" onclick="previousPage()" id="prevBtn">
                    <i class="fas fa-angle-left"></i> Previous
                </button>
                <span class="page-info" id="pageInfo">Page 1 of 1</span>
                <button class="btn-pagination" onclick="nextPage()" id="nextBtn">
                    Next <i class="fas fa-angle-right"></i>
                </button>
                <button class="btn-pagination" onclick="lastPage()" id="lastBtn">
                    <i class="fas fa-angle-double-right"></i>
                </button>
            </div>
        </div>
    </div>
</main>

<div id="userModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>User Details</h2>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>

<div id="confirmModal" class="modal" style="display: none;">
    <div class="modal-content small">
        <div class="modal-header">
            <h3 id="confirmTitle">Confirm Action</h3>
            <button class="modal-close" onclick="closeConfirmModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p id="confirmMessage">Are you sure?</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
                <button class="btn btn-danger" id="confirmBtn" onclick="confirmAction()">Confirm</button>
            </div>
        </div>
    </div>
</div>

<div id="regionModal" class="modal" style="display: none;">
    <div class="modal-content small" style="max-width: 450px;">
        <div class="modal-header">
            <h3>Select Manager Region</h3>
            <button class="modal-close" onclick="closeRegionModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 20px;">
            <p style="margin-bottom: 10px; color: #666;">Please select the region this manager will be in charge of:</p>
            <select id="regionSelect" class="region-select-modal" style="width: 100%; padding: 10px; margin: 15px 0; border-radius: 5px; border: 1px solid #ddd; font-size: 14px;">
                <option value="">-- Select Region --</option>
                <option value="SEA">SEA</option>
                <option value="ChinaKorJap">China/Korea/Japan</option>
                <option value="EuropeMdiEastAfrica">Europe/Middle East/Africa</option>
                <option value="USMexBrazil">US/Mexico/Brazil</option>
            </select>
            <div class="modal-actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeRegionModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmRegionSelection()">Confirm</button>
            </div>
        </div>
    </div>
</div>

<div id="editRegionModal" class="modal" style="display: none;">
    <div class="modal-content small" style="max-width: 450px;">
        <div class="modal-header">
            <h3>Edit Manager Region</h3>
            <button class="modal-close" onclick="closeEditRegionModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 20px;">
            <p style="margin-bottom: 10px; color: #666;">Update the region for this manager:</p>
            <select id="editRegionSelect" class="region-select-modal" style="width: 100%; padding: 10px; margin: 15px 0; border-radius: 5px; border: 1px solid #ddd; font-size: 14px;">
                <option value="">-- Select Region --</option>
                <option value="SEA">SEA</option>
                <option value="ChinaKorJap">China/Korea/Japan</option>
                <option value="EuropeMdiEastAfrica">Europe/Middle East/Africa</option>
                <option value="USMexBrazil">US/Mexico/Brazil</option>
            </select>
            <div class="modal-actions" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeEditRegionModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmEditRegion()">Update</button>
            </div>
        </div>
    </div>
</div>

<script>
const { Client, Account, Databases, Query } = window.Appwrite;
const client = new Client();
client.setEndpoint("https://fra.cloud.appwrite.io/v1")
.setProject("68ddd7de00255d4f5c96");

const account = new Account(client);
const database = new Databases(client);

const databaseId = "68ba8a9c001f17064e15";
const collectionId = "68ba8c240002116fa647";

let users = [];
let filteredUsers = [];
let selectedUsers = [];
let currentPage = 1;
const perPage = 20;
let sortDirection = { name: 'asc', email: 'asc', registrationDate: 'desc' };
let currentSortField = 'registrationDate';

async function checkSession() {
    try {
        const user = await account.get();
        console.log('Logged in as:', user.email);
        document.querySelector('h1').textContent = `Welcome, ${user.name || 'Admin'}`;
    } catch (err) {
        console.error('Session check error:', err);
        console.warn('No active session, redirecting');
        window.location.href = 'index.html';
    }
}

async function logout() {
    try {
        await account.deleteSession('current');
        console.log('Logged out successfully');
    } catch (err) {
        console.warn('Could not delete session (maybe already logged out):', err);
    } finally {
        window.location.href = 'index.html';
    }
}

document.getElementById("logoutBtn").addEventListener("click", (e) => {
    e.preventDefault();
    logout();
});

setInterval(() => {
    fetchUsers();
}, 30000);

async function fetchUsers() {
    try {
        const res = await database.listDocuments(
            databaseId, 
            collectionId, 
            [Query.limit(1000)]
        );
        users = res.documents.map(doc => ({
            id: doc.$id,
            name: doc.username || doc.name || '',
            email: doc.email || '',
            role: doc.role || 'staff',
            status: doc.status || 'approved',
            region: doc.region || '',
            registrationDate: doc.registerDate || doc.$createdAt,
            isVitrox: doc.email?.endsWith('@vitrox.com') || false
        }));

        applySorting();
        filteredUsers = [...users];
        renderUsers();
        updateStats();
    } catch (err) {
        console.error('Error fetching users:', err);
        showNotification('Failed to load users', 'error');
    }
}

async function updateUserField(userId, field, value) {
    try {
        await database.updateDocument(databaseId, collectionId, userId, { [field]: value });
        const user = users.find(u => u.id === userId);
        if (user) user[field] = value;
        applySorting();
        filterUsers();
        updateStats();
    } catch (err) {
        console.error(err);
        showNotification("Update failed", "error");
    }
}

function changeUserRole(userId, newRole) { 
    updateUserField(userId, 'role', newRole); 
}

let pendingRoleChange = null;

async function updateManagerRegion(userId, region) {
    if (!region) {
        showNotification('Please select a region', 'error');
        const user = users.find(u => u.id === userId);
        renderUsers();
        return;
    }
    
    try {
        await database.updateDocument(databaseId, collectionId, userId, { region: region });
        const user = users.find(u => u.id === userId);
        if (user) {
            user.region = region;
        }
        applySorting();
        filterUsers();
    } catch (err) {
        console.error(err);
        showNotification('Failed to update region', 'error');
        renderUsers();
    }
}

function handleRoleChange(userId, newRole, currentRole) {
    if (newRole === 'manager' && currentRole !== 'manager') {
        pendingRoleChange = { userId, newRole };
        const user = users.find(u => u.id === userId);
        if (user && user.region) {
            document.getElementById('regionSelect').value = user.region;
        } else {
            document.getElementById('regionSelect').value = '';
        }
        document.getElementById('regionModal').style.display = 'flex';
    } else {
        if (currentRole === 'manager' && newRole !== 'manager') {
            updateUserField(userId, 'region', '');
        }
        changeUserRole(userId, newRole);
    }
}

function closeRegionModal() {
    document.getElementById('regionModal').style.display = 'none';
    pendingRoleChange = null;
    renderUsers();
}

async function confirmRegionSelection() {
    const region = document.getElementById('regionSelect').value;
    if (!region) {
        showNotification('Please select a region', 'error');
        return;
    }
    
    if (pendingRoleChange) {
        try {
            await database.updateDocument(databaseId, collectionId, pendingRoleChange.userId, {
                role: 'manager',
                region: region
            });
            const user = users.find(u => u.id === pendingRoleChange.userId);
            if (user) {
                user.role = 'manager';
                user.region = region;
            }
            applySorting();
            filterUsers();
            updateStats();
            closeRegionModal();
        } catch (err) {
            console.error(err);
            showNotification('Failed to update role and region', 'error');
        }
    }
}

async function deleteUser(userId) {
    if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
    
    try {
        await database.deleteDocument(databaseId, collectionId, userId);
        users = users.filter(u => u.id !== userId);
        applySorting();
        filterUsers();
        updateStats();
        showNotification("User deleted successfully", "success");
    } catch (err) {
        console.error(err);
        showNotification("Delete failed", "error");
    }
}

function sortTable(field) {
    currentSortField = field;
    sortDirection[field] = sortDirection[field] === 'asc' ? 'desc' : 'asc';
    applySorting();
    filterUsers();
}

function applySorting() {
    const field = currentSortField;
    const direction = sortDirection[field];
    
    users.sort((a, b) => {
        let aVal = a[field];
        let bVal = b[field];
        
        if (field === 'registrationDate') {
            aVal = new Date(aVal);
            bVal = new Date(bVal);
        } else if (typeof aVal === 'string') {
            aVal = aVal.toLowerCase();
            bVal = bVal.toLowerCase();
        }
        
        if (aVal < bVal) return direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return direction === 'asc' ? 1 : -1;
        return 0;
    });
}

function renderUsers() {
    const tbody = document.getElementById('usersTableBody');
    tbody.innerHTML = '';
    const start = (currentPage - 1) * perPage;
    const end = start + perPage;
    const pageUsers = filteredUsers.slice(start, end);
    
    if (pageUsers.length === 0) {
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('pagination').style.display = 'none';
        return;
    } else {
        document.getElementById('emptyState').style.display = 'none';
        if (filteredUsers.length > perPage) {
            document.getElementById('pagination').style.display = 'flex';
        }
    }
    
    pageUsers.forEach(user => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
        <td><input type="checkbox" class="user-checkbox" value="${user.id}" onchange="updateSelection()"></td>
        <td>${user.name || '-'}</td>
        <td>${user.email} ${user.isVitrox ? '<i class="fas fa-shield-alt" style="color: #4CAF50;" title="Vitrox Email"></i>' : ''}</td>
        <td>
            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                <select class="role-select" onchange="handleRoleChange('${user.id}', this.value, '${user.role}')" style="flex: 0 0 auto;">
                    <option value="staff" ${user.role === 'staff' ? 'selected' : ''}>Staff</option>
                    <option value="manager" ${user.role === 'manager' ? 'selected' : ''}>Manager</option>
                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                </select>
                ${user.role === 'manager' ? `
                    <select class="region-select-inline" onchange="updateManagerRegion('${user.id}', this.value)" style="flex: 0 0 auto; padding: 6px 10px; border-radius: 4px; border: 1px solid #ddd; font-size: 13px; background: #f8f9fa;">
                        <option value="">Select Region</option>
                        <option value="SEA" ${user.region === 'SEA' ? 'selected' : ''}>SEA</option>
                        <option value="ChinaKorJap" ${user.region === 'China/Korea/Japan' ? 'selected' : ''}>China/Korea/Japan</option>
                        <option value="EuropeMdiEastAfrica" ${user.region === 'Europe/Middle East/Africa' ? 'selected' : ''}>Europe/Middle East/Africa</option>
                        <option value="USMexBrazil" ${user.region === 'US/Mexico/Brazil' ? 'selected' : ''}>US/Mexico/Brazil</option>
                    </select>
                ` : ''}
            </div>
        </td>
        <td>${formatDate(user.registrationDate)}</td>
        <td>
        <div class="action-buttons">
            <button class="btn-icon" onclick="viewUser('${user.id}')" title="View Details">
                <i class="fas fa-eye"></i>
            </button>
            <button class="btn-icon danger" onclick="deleteUser('${user.id}')" title="Delete User">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        </td>
        `;
        tbody.appendChild(tr);
    });
    
    updatePaginationInfo();
}

function updatePaginationInfo() {
    const totalPages = Math.ceil(filteredUsers.length / perPage);
    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
    document.getElementById('firstBtn').disabled = currentPage === 1;
    document.getElementById('prevBtn').disabled = currentPage === 1;
    document.getElementById('nextBtn').disabled = currentPage >= totalPages;
    document.getElementById('lastBtn').disabled = currentPage >= totalPages;
}

function viewUser(userId) {
    const user = users.find(u => u.id === userId);
    if (user) {
        const modalBody = document.getElementById('modalBody');
        modalBody.innerHTML = generateUserDetailsHTML(user);
        document.querySelector('#userModal h2').textContent = user.name || "User Details";
        document.getElementById('userModal').style.display = 'flex';
    }
}

window.onclick = function(event) {
    const userModal = document.getElementById('userModal');
    const regionModal = document.getElementById('regionModal');
    
    if (event.target === userModal) {
        closeModal();
    } else if (event.target === regionModal) {
        closeRegionModal();
    }
};

function generateUserDetailsHTML(user) {
    return `
        <div class="details-grid">
            <div class="detail-item">
                <label>Username:</label>
                <span>${user.name || '-'}</span>
            </div>
            <div class="detail-item">
                <label>Email:</label>
                <span>${user.email}</span>
            </div>
            <div class="detail-item">
                <label>Role:</label>
                <span class="role-badge ${user.role}">${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</span>
            </div>
            ${user.role === 'manager' && user.region ? `
            <div class="detail-item">
                <label>Region:</label>
                <span class="region-badge">${user.region}</span>
            </div>
            ` : ''}
            <div class="detail-item">
                <label>Registration Date:</label>
                <span>${formatDate(user.registrationDate)}</span>
            </div>
            <div class="detail-item">
                <label>Email Type:</label>
                <span>${user.isVitrox ? 'Vitrox Corporate' : 'External'}</span>
            </div>
        </div>
    `;
}

function closeModal() {
    document.getElementById('userModal').style.display = 'none';
}

function closeConfirmModal() {
    document.getElementById('confirmModal').style.display = 'none';
}

function firstPage() {
    currentPage = 1;
    renderUsers();
}

function previousPage() {
    if (currentPage > 1) {
        currentPage--;
        renderUsers();
    }
}

function nextPage() {
    const totalPages = Math.ceil(filteredUsers.length / perPage);
    if (currentPage < totalPages) {
        currentPage++;
        renderUsers();
    }
}

function lastPage() {
    const totalPages = Math.ceil(filteredUsers.length / perPage);
    currentPage = totalPages;
    renderUsers();
}

function filterUsers() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const role = document.getElementById('roleFilter').value;
    const region = document.getElementById('regionFilter').value;

    filteredUsers = users.filter(u => {
        const matchSearch = (u.name || '').toLowerCase().includes(search) || (u.email || '').toLowerCase().includes(search);
        const matchRole = role === 'all' || u.role === role;
        const matchRegion = region === 'all' || (u.role === 'manager' && u.region === region);
        return matchSearch && matchRole && matchRegion;
    });

    currentPage = 1;
    renderUsers();
}

function formatDate(dateStr) {
    const d = new Date(dateStr);
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
}

function updateStats() {
    document.getElementById('totalCount').textContent = users.length;
    document.getElementById('staffCount').textContent = users.filter(u => u.role === 'staff').length;
    document.getElementById('managerCount').textContent = users.filter(u => u.role === 'manager').length;
    document.getElementById('adminCount').textContent = users.filter(u => u.role === 'admin').length;
}

function updateSelection() {
    const checkboxes = document.querySelectorAll('.user-checkbox:checked');
    selectedUsers = Array.from(checkboxes).map(cb => cb.value);
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = selectAll.checked);
    updateSelection();
}

function showNotification(msg, type) {
    const notif = document.createElement('div');
    notif.className = `notification ${type}`;
    notif.innerHTML = `<span>${msg}</span>`;
    document.body.appendChild(notif);
    setTimeout(() => { notif.remove(); }, 3000);
}

document.addEventListener('DOMContentLoaded', async () => {
    await checkSession();
    await fetchUsers();
});
</script>

<footer class="footer">
    <div>
        <span>© 2025 ViTrox. All rights reserved.</span>
    </div>
</footer>
</body>
</html>



