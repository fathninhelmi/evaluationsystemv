<!DOCTYPE html> 
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evaluation Form Details</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="./style.css">
<script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0/dist/iife/sdk.js"></script>
</head>
<body>
<header class="header">
    <a href="#" class="logo"><img src="logo.png" alt="logo"></a>
</header>

<div id="eventCard" class="card">
  <p>Loading event</p>
</div>

<script>
const { Client, Databases } = window.Appwrite;
const client = new Client();
client.setEndpoint("https://fra.cloud.appwrite.io/v1").setProject("68ddd7de00255d4f5c96");

const databases = new Databases(client);

const databaseId = "68ba8a9c001f17064e15";
const mainCollectionId = "68ba918c0022d2b9a429";
const preEvalCollectionIds = {
  'AOI': '68c7ced6001bd14d08f4',
  'SPI': '696dd2b1000c4e985d76',
  'AXI': '696ed4b900377582df31',
  'ARV': '696dd29b0034536c09b9', 
  'XC': '696dd2f20006c0eef2a1',  
  'XS': '696dd301001cd0f6da66'  
};
const evalCollectionId = "68bf9d5600257a20775a";
const postEvalCollectionId = "68bf9d62002b4f5f7f23";

const params = new URLSearchParams(window.location.search);
const eventId = params.get("id");
const fromPage = params.get("from");

const eventCard = document.getElementById("eventCard");

const getStepClass = (status) => {
    switch (status) {
        case "draft": return "pending";
        case "in progress": return "active";
        case "complete": return "completed";
        case "drop": return "drop";
        default: return "pending";
    }
};

async function loadEvent() {
    try {
        const ev = await databases.getDocument(databaseId, mainCollectionId, eventId);
        console.log('Loaded event:', ev);

        const productType = (ev.productType || "AOI").toUpperCase().trim();
        const preEvalCollectionId = preEvalCollectionIds[productType] || preEvalCollectionIds['AOI'];
        
        const preEvalStatus = await getFormStatus(preEvalCollectionId, eventId);
        const evalStatus = await getFormStatus(evalCollectionId, eventId);
        const postEvalStatus = await getFormStatus(postEvalCollectionId, eventId);

        console.log('Form statuses:', { preEvalStatus, evalStatus, postEvalStatus });

        const isViewMode = fromPage === 'manager';
        const viewModeIndicator = isViewMode 
            ? `<div style="background: #ffc107; color: #333; padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 15px; font-weight: 500;">
                 üëÅÔ∏è View-Only Mode (Manager Access)
               </div>` 
            : '';
        const productType = (ev.productType || "").toLowerCase().trim();
        const hideEvalStep = productType === "xs" || productType === "xc" || 
                            productType === "smart code reader (xs)" || 
                            productType === "smart camera (xc)";
        eventCard.innerHTML = `
            <h1>${ev.prodname} (${ev.createDate ? formatDate(ev.createDate) : ""})</h1>
            ${viewModeIndicator}
            <div class="wizard">
                <div class="step-container">
                    <div class="step ${getStepClass(preEvalStatus)}" onclick="goToStep('preeval.html', '${eventId}', ${isViewMode})">1</div>
                    <div class="step-label">Pre Evaluation</div>
                </div>
                ${!hideEvalStep ? `
                <div class="step-container">
                    <div class="step ${getStepClass(evalStatus)}" onclick="goToStep('eval.html', '${eventId}', ${isViewMode})">2</div>
                    <div class="step-label">Evaluation</div>
                </div>
                ` : ''}
                <div class="step-container">
                    <div class="step ${getStepClass(postEvalStatus)}" onclick="goToStep('posteval.html', '${eventId}', ${isViewMode})">${!hideEvalStep ? '3' : '2'}</div>
                    <div class="step-label">Post Evaluation</div>
                </div>
            </div>
            
           <div style="margin-top: 30px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #f5f5f5;">
                    Evaluation Report Link:
                </label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input 
                        type="url" 
                        id="reportLink" 
                        placeholder="Enter evaluation report link" 
                        value="${ev.reportLink || ''}"
                        style="flex: 1; padding: 12px; border-radius: 6px; border: 1px solid #2c5ca5; background: #0e2952; color: #fff; font-size: 14px;"
                        ${isViewMode ? 'readonly' : ''}
                    />
                    <button 
                        id="openLinkBtn"
                        onclick="openReportLink()"
                        title="Open link in new tab"
                        style="padding: 12px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; transition: background 0.3s; display: flex; align-items: center; justify-content: center; width: 48px; height: 48px; flex-shrink: 0;"
                        onmouseover="this.style.background='#2980b9'"
                        onmouseout="this.style.background='#3498db'"
                        ${!ev.reportLink ? 'disabled style="opacity: 0.5; cursor: not-allowed; padding: 12px; background: #3498db; width: 48px; height: 48px;"' : ''}
                    >
                        Open Link
                    </button>
                </div>
                <div id="saveStatus" style="margin-top: 8px; font-size: 12px; color: #4ea8de; min-height: 20px;"></div>
            </div>
            <button class="back-btn" onclick="goBack()">Back</button>
        `;
        if (!isViewMode) {
            autoSaveReportLink();
        }
    } catch (err) {
        console.error("Failed to load event:", err);
        eventCard.innerHTML = "<p>Event not found.</p>";
    }
}

let saveTimeout;
async function autoSaveReportLink() {
    const reportLinkInput = document.getElementById('reportLink');
    const saveStatus = document.getElementById('saveStatus');
    const openLinkBtn = document.getElementById('openLinkBtn');
    
    if (!reportLinkInput) return;
    
    reportLinkInput.addEventListener('input', async (e) => {
        clearTimeout(saveTimeout);
        saveStatus.textContent = 'Typing...';
        
        if (openLinkBtn) {
            if (e.target.value.trim()) {
                openLinkBtn.disabled = false;
                openLinkBtn.style.opacity = '1';
                openLinkBtn.style.cursor = 'pointer';
            } else {
                openLinkBtn.disabled = true;
                openLinkBtn.style.opacity = '0.5';
                openLinkBtn.style.cursor = 'not-allowed';
            }
        }
        
        saveTimeout = setTimeout(async () => {
            try {
                saveStatus.textContent = 'Saving...';
                await databases.updateDocument(
                    databaseId, 
                    mainCollectionId, 
                    eventId, 
                    { reportLink: e.target.value }
                );
                saveStatus.textContent = '‚úì Saved';
                setTimeout(() => {
                    saveStatus.textContent = '';
                }, 2000);
            } catch (err) {
                console.error('Failed to save:', err);
                saveStatus.textContent = '‚úó Failed to save';
                saveStatus.style.color = '#e63946';
            }
        }, 1000);
    });
}

function openReportLink() {
    const reportLinkInput = document.getElementById('reportLink');
    const link = reportLinkInput.value.trim();
    
    if (!link) {
        alert('Please enter a report link first.');
        return;
    }
    let fullLink = link;
    if (!link.startsWith('http://') && !link.startsWith('https://')) {
        fullLink = 'https://' + link;
    }
    window.open(fullLink, '_blank');
}

async function getFormStatus(collectionId, eventId) {
    try {
        const doc = await databases.getDocument(databaseId, collectionId, eventId);
        return doc.status || "draft";
    } catch (err) {
        if (err.message.includes("Document with the requested ID could not be found")) {
            return "draft";
        }
        console.warn("Error checking form status:", err);
        return "draft";
    }
}

function formatDate(dateStr) {
    const d = new Date(dateStr);
    return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
}

function goBack() { 
    if (fromPage === 'manager') {
        window.location.href = 'manager.html';
    } else {
        window.location.href = 'createform.html';
    }
}

async function goToStep(page, eventId, isViewMode = false) {
    try {
        const mainDoc = await databases.getDocument(databaseId, mainCollectionId, eventId);
        console.log("Product Type from database:", mainDoc.productType); 
        
        // Get correct collection ID based on product type
        const productTypeUpper = (mainDoc.productType || "AOI").toUpperCase().trim();
        let collectionId;
        
        if (page.includes("preeval")) {
            collectionId = preEvalCollectionIds[productTypeUpper] || preEvalCollectionIds['AOI'];
        } else if (page.includes("eval.html")) {
            collectionId = evalCollectionId;
        } else if (page.includes("posteval")) {
            collectionId = postEvalCollectionId;
        }

        let formDoc;
        try {
            formDoc = await databases.getDocument(databaseId, collectionId, eventId);
            console.log("Form document exists:", formDoc);
        } catch (err) {
            if (err.message.includes("Document with the requested ID could not be found")) {
                if (!isViewMode) {
                    console.log("Creating new form document with ID:", eventId);
                    formDoc = await databases.createDocument(databaseId, collectionId, eventId, {
                        status: "draft",
                        username: (mainDoc.username && typeof mainDoc.username === "string") ? mainDoc.username : "Unknown",
                        email: (mainDoc.email && typeof mainDoc.email === "string") ? mainDoc.email : "no-email@system.local",
                        customerCompany: mainDoc.customerCompany || "",
                        prodname: mainDoc.prodname || "",
                        productType: mainDoc.productType || ""
                    });
                    console.log("Created new form document:", formDoc);
                } else {
                    alert("This form has not been created yet. Nothing to view.");
                    return;
                }
            } else {
                throw err;
            }
        }

        if (page.includes("preeval")) {
            let preevalPage;
            const productType = (mainDoc.productType || "").toLowerCase().trim();
            console.log("Processed product type:", productType); 
            
            switch (productType) {
                case "xs":
                case "smart code reader (xs)": 
                    preevalPage = "preevalXS.html";
                    console.log("Redirecting to XS pre-eval");
                    break;
                case "xc":
                case "smart camera (xc)": 
                    preevalPage = "preevalXC.html";
                    console.log("Redirecting to XC pre-eval");
                    break;
                case "aoi":
                    preevalPage = "preeval.html";
                    console.log("Redirecting to AOI pre-eval");
                    break;
                case "spi":
                    preevalPage = "preevalSPI.html";
                    console.log("Redirecting to SPI pre-eval");
                    break;
                case "arv":
                    preevalPage = "preevalARV.html";
                    console.log("Redirecting to ARV pre-eval");
                    break;
                case "axi":
                    preevalPage = "preevalAXI.html";
                    console.log("Redirecting to AXI pre-eval");
                    break;
                default:
                    preevalPage = "preeval.html";
                    console.log("Redirecting to default pre-eval");
            }
            page = preevalPage;
        }
        console.log("Final page to navigate to:", page); 

        const viewModeParam = isViewMode ? '&mode=view' : '';
        window.location.href = `${page}?id=${eventId}${viewModeParam}`;

    } catch (err) {
        console.error("Failed to navigate to step:", err);
        alert("Error: " + err.message);
    }
}

loadEvent();
</script>

<footer class="footer-regis">
    <span>¬© 2025 ViTrox. All rights reserved.</span>
</footer>
</body>

</html>


