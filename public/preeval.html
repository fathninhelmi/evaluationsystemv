<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="./style.css">
<title>Pre Evaluation Form</title>
<script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0/dist/iife/sdk.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>

<header class="header">
    <a href="#" class="logo"><img src="logo.png" alt="logo"></a>
</header>

<div class="card-eval">
    <div class="form-header">
        <h1 id="formTitle">Pre-Evaluation Form</h1>
        <span id="statusBadge" class="status-badge"></span>
    </div>
    
    <div id="loadingIndicator" class="loading" style="display: none;">
        Loading form data
    </div>
    
    <form id="preEvalForm" style="display: none;">

        <!-- Section 1 -->
        <div class="form-section two-column">
            <div class="section-title">1. GENERAL</div>
            <div class="form-group-evalxc-compact">
                <label>Customer Company Name :</label>
                <input type="text" id="customerCompany" name="customerCompany" required>
            </div>
            <div class="form-group-evalxc-compact">
                <label>Customer Tech Champion :</label>
                <input type="text" id="custTechChamp" name="custTechChamp" required>
            </div>
            <div class="form-group-evalxc-compact">
                <label>Existing customer? :</label>
                <select id="existcust" name="existcust">
                    <option value="">Select</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>
            </div>
            <div class="form-group-evalxc-compact">
                <label>Evaluation Date :</label>
                <input type="date" id="evalDate" name="evalDate" required>
            </div>
            <div class="form-group-evalxc-compact">
                <label>Competitor(s) if any :</label>
                <input type="text" id="competitor" name="competitor">
            </div>
            <div class="form-group-evalxc-compact">
                <label>Competitor machine model :</label>
                <input type="text" id="compModel" name="compModel">
            </div>
            <div class="form-group-evalxc-compact">
                <label>Venue :</label>
                <select id="venue" name="venue" required>
                    <option value="">Select</option>
                    <option value="customer_site">Customer site</option>
                    <option value="in_house">In House</option>
                    <option value="scp_office">SCP office</option>
                </select>
            </div>
        </div>

        <!-- Section 2 -->
        <div class="form-section two-column">
            <div class="section-title">2. RESOURCES</div>
            <div class="form-group-evalxc-compact">
                <label>SCP Sales Champion :</label>
                <input type="text" id="scpsalesChamp" name="scpsalesChamp" required>
            </div>
            <div class="form-group-evalxc-compact">
                <label>SCP Technical Champion :</label>
                <input type="text" id="scptechChamp" name="scptechChamp" required>
            </div>
            <div class="form-group-evalxc-compact">
                <label>ViTrox Sales Champion :</label>
                <input type="text" id="vitroxsalesChamp" name="vitroxsalesChamp" required>
            </div>
            <div class="form-group-evalxc-compact">
                <label>ViTrox Tech Champion :</label>
                <input type="text" id="vitroxtechChamp" name="vitroxtechChamp" required>
            </div>
        </div>

        <!-- Section 3 --->
        <div class="form-section two-column">
            <div class="section-title">3. TARGET INSPECTION PERFORMANCE</div>
            <div class="form-group-evalxc-compact">
                <label>Inspection environment :</label>
                <select id="inspectionEnvironment" name="inspectionEnvironment">
                    <option value="">Select</option>
                    <option value="offline_only">Offline only</option>
                    <option value="offline_inline">Offline & Inline</option>
                </select>
            </div>
            <div class="form-group-evalxc-compact">
                <label>FPY target if any :</label>
                <select id="fpyTarget" name="fpyTarget">
                    <option value="">Select</option>
                    <option value="95">â‰¥ 95%</option>
                    <option value="no_concern">No concern</option>
                </select>
            </div>
            <div class="form-group-evalxc-compact">
                <label>Product segment :</label>
                <select id="prodseg" name="prodseg">
                    <option value="">Select</option>
                    <option value="aerospace">Aerospace</option>
                    <option value="medical">Medical</option>
                    <option value="military">Military</option>
                    <option value="telecom">Telecommunication</option>
                    <option value="consumer">Consumer product</option>
                    <option value="semicon">Semicon</option>
                </select>
            </div>
            <div class="form-group-evalxc-compact">
                <label>Require angular inspection :</label>
                <select id="reqinspect" name="reqinspect">
                    <option value="">Select</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                </select>
            </div>
            <div class="form-group-evalxc-compact">
                <label>Cycle time requirement :</label>
                <input type="text" id="cycleTime" name="cycleTime">
            </div>
            <div class="form-group-evalxc-compact">
                <label>False call PPM :</label>
                <input type="text" id="falseCallppm" name="falseCallppm" required>
            </div>
            <div class="form-group-evalxc" style="grid-column: span 2;">
                <label>Others :</label>
                <textarea id="otherreq" name="otherreq" style="max-width: 100%; width: 100%;"></textarea>
            </div>
        </div>

        <!-- Section 4 -->
        <div class="form-section">
            <div class="section-title">4. PCB</div>
                <div class="checkbox-grid-xc">
                <div class="requirement-xc">Board thickness :</div>
                <div class="checkbox-options-xc">
                    <label><input type="checkbox" name="boardThickness" value="normal_0_5_4mm">Normal (0.5 - 4mm)</label>
                    <label><input type="checkbox" name="boardThickness" value="gt_4mm">&gt;4mm</label>
                    <label><input type="checkbox" name="boardThickness" value="lt_100um">&lt;100um</label>
                </div>
            </div>

            <div class="checkbox-grid-xc">
                <div class="requirement-xc">Smallest Component size :</div>
                <div class="checkbox-options-xc">
                    <label><input type="checkbox" name="smallestComponentSize" value="0201">0201</label>
                    <label><input type="checkbox" name="smallestComponentSize" value="01005">01005</label>
                    <label><input type="checkbox" name="smallestComponentSize" value="008004_03015">008004 / 03015</label>
                </div>
            </div>

            <div class="checkbox-grid-xc">
                <div class="requirement-xc">Inspection requirement :</div>
                <div class="checkbox-options-xc">
                    <label><input type="checkbox" name="inspectionRequirement" value="general_smt">General SMT</label>
                    <label><input type="checkbox" name="inspectionRequirement" value="smt_tht">SMT & THT</label>
                    <label><input type="checkbox" name="inspectionRequirement" value="non_smt">non-SMT inspection</label>
                    <label><input type="checkbox" name="inspectionRequirement" value="z_height">Z-Height</label>
                </div>
            </div>

            <div class="checkbox-grid-xc">
                <div class="requirement-xc">Programming Input files :</div>
                <div class="checkbox-options-xc">
                    <label><input type="checkbox" name="programmingInputFiles" value="general_cad">General CAD</label>
                    <label><input type="checkbox" name="programmingInputFiles" value="gerber">Gerber</label>
                    <label><input type="checkbox" name="programmingInputFiles" value="bom">BOM</label>
                    <label><input type="checkbox" name="programmingInputFiles" value="xy_placement">XY placement files</label>
                </div>
            </div>
        </div>

        <!-- Section 5 -->
        <div class="form-section">
            <div class="section-title">5. MACHINE TYPE</div>
                <div class="checkbox-grid-xc">
                <div class="requirement-xc">Conveyor :</div>
                <div class="checkbox-options-xc">
                    <label><input type="checkbox" name="conveyor" value="staging">Staging</label>
                    <label><input type="checkbox" name="conveyor" value="linear_guide_awa">Linear Guide AWA</label>
                    <label><input type="checkbox" name="conveyor" value="vacuum_table_awa">Vacuum Table AWA</label>
                    <label><input type="checkbox" name="conveyor" value="vvts_usb_io_card">VVTS USB IO Card</label>
                    <label><input type="checkbox" name="conveyor" value="long_board">Long Board</label>
                    <label><input type="checkbox" name="conveyor" value="center_pin">Center Pin</label>
                </div>
            </div>

            <div class="checkbox-grid-xc">
                <div class="requirement-xc">Machine type selection by board size :</div>
                <div class="checkbox-options-xc">
                    <label><input type="checkbox" name="machineTypeByBoardSize" value="standard">Standard</label>
                    <label><input type="checkbox" name="machineTypeByBoardSize" value="xl">XL</label>
                    <label><input type="checkbox" name="machineTypeByBoardSize" value="xxl">XXL</label>
                    <label><input type="checkbox" name="machineTypeByBoardSize" value="single_lane">Single Lane</label>
                    <label><input type="checkbox" name="machineTypeByBoardSize" value="dual_lane">Dual Lane</label>
                    <label><input type="checkbox" name="machineTypeByBoardSize" value="no_concern">No Concern</label>
                </div>
            </div>

            <div class="checkbox-grid-xc">
                <div class="requirement-xc">Board Flow Direction :</div>
                <div class="checkbox-options-xc">
                    <label><input type="checkbox" name="boardFlowDirection" value="l_r">L-R</label>
                    <label><input type="checkbox" name="boardFlowDirection" value="r_l">R-L</label>
                    <label><input type="checkbox" name="boardFlowDirection" value="l_l">L-L</label>
                    <label><input type="checkbox" name="boardFlowDirection" value="r_r">R-R</label>
                </div>
            </div>

            <div class="form-group-evalxc">
                <label>Board Stop Requirement :</label>
                <select id="boardStopRequirement" name="boardStopRequirement">
                    <option value="">Select</option>
                    <option value="hard_stop">Hard Stop</option>
                    <option value="sensor_stop">Sensor Stop</option>
                </select>
            </div>
        </div>

        <!-- Section 6 -->
        <div class="form-section">
            <div class="section-title">6. VISION</div>
                <div class="checkbox-grid-xc">
                <div class="requirement-xc">Lens :</div>
                <div class="checkbox-options-xc">
                    <label><input type="checkbox" name="lens" value="13um">13um</label>
                    <label><input type="checkbox" name="lens" value="15um">15um</label>
                    <label><input type="checkbox" name="lens" value="10um">10um</label>
                    <label><input type="checkbox" name="lens" value="8um">8um</label>
                </div>
            </div>

            <div class="form-group-evalxc">
                <label>Coaxial Lighting :</label>
                <select id="coaxialLighting" name="coaxialLighting">
                    <option value="">Select</option>
                    <option value="required">Required</option>
                    <option value="not_required">Not required</option>
                </select>
            </div>
        </div>

        <!-- Section 7 -->
        <div class="form-section">
            <div class="section-title">7. PC SPECS</div>
            <div class="checkbox-grid-xc">
                <div class="requirement-xc">Hardisc capacity :</div>
                <div class="checkbox-options-xc">
                    <label><input type="checkbox" name="hardiscCapacity" value="512gb_ssd">&gt;512GB SSD</label>
                </div>
            </div>
        </div>

        <!-- Section 8 -->
        <div class="form-section">
        <div class="section-title">8. FEATURES & TOOLS</div>
        <div class="checkbox-gridpr">
            <div class="header-evalpr"></div>
            <div class="header-evalpr">Software</div>
            <div class="header-evalpr">Hardware</div>
            <div class="requirementpr">V-Library </div>
            <div class="checkbox-containerpr">
            <div class="checkbox-itempr">
                <input type="checkbox" name="vLibrarySoftware" value="system_gt_32gb_ram">
                <label>System &gt;32GB RAM <i class="fas fa-info-circle info-icon" data-tool="system_gt_32gb_ram"></i></label>
            </div>
            </div>
            <div class="checkbox-containerpr">
            <div class="checkbox-itempr">
                <input type="checkbox" name="vLibraryHardware" value="server">
                <label>Server <i class="fas fa-info-circle info-icon" data-tool="server"></i></label>
            </div>
            </div>
            <div class="requirementpr">AI Programming </div>
            <div class="checkbox-containerpr">
            <div class="checkbox-itempr">
                <input type="checkbox" name="aiProgrammingSoftware" value="vayo_accelerator">
                <label>Vayo Accelerator <i class="fas fa-info-circle info-icon" data-tool="vayo_accelerator"></i></label>
            </div>
            </div>
            <div class="checkbox-containerpr">
            <div class="checkbox-itempr">
                <input type="checkbox" name="aiProgrammingHardware" value="mentor_graphics_opm">
                <label>Mentor graphics OPM <i class="fas fa-info-circle info-icon" data-tool="mentor_graphics_opm"></i></label>
            </div>
            </div>
            <div class="requirementpr">VVTS </div>
            <div class="checkbox-containerpr">
            <div class="checkbox-itempr">
                <input type="checkbox" name="vvtsSoftware" value="license">
                <label>License <i class="fas fa-info-circle info-icon" data-tool="vvts_license"></i></label>
            </div>
            </div>
            <div class="checkbox-containerpr">
            <div class="checkbox-itempr">
                <input type="checkbox" name="vvtsHardware" value="pc">
                <label>PC <i class="fas fa-info-circle info-icon" data-tool="vvts_pc"></i></label>
            </div>
            <div class="checkbox-itempr">
                <input type="checkbox" name="vvtsHardware" value="one_aoi_to_multiple">
                <label>One AOI to multiple <i class="fas fa-info-circle info-icon" data-tool="vvts_one_aoi"></i></label>
            </div>
            </div>
            <div class="requirementpr">AI VVTS </div>
            <div class="checkbox-containerpr">
            <div class="checkbox-itempr">
                <input type="checkbox" name="aiVvtsSoftware" value="license">
                <label>License <i class="fas fa-info-circle info-icon" data-tool="ai_vvts_license"></i></label>
            </div>
            </div>
            <div class="checkbox-containerpr">
            <div class="checkbox-itempr">
                <input type="checkbox" name="aiVvtsHardware" value="pc">
                <label>PC <i class="fas fa-info-circle info-icon" data-tool="ai_vvts_pc"></i></label>
            </div>
            <div class="checkbox-itempr">
                <input type="checkbox" name="aiVvtsHardware" value="one_aoi_to_multiple">
                <label>One AOI to multiple <i class="fas fa-info-circle info-icon" data-tool="ai_vvts_one_aoi"></i></label>
            </div>
            </div>
            <div class="requirementpr">VDSPC 2.0 </div>
            <div class="checkbox-containerpr">
            <div class="checkbox-itempr">
                <input type="checkbox" name="vdspcSoftware" value="license">
                <label>License <i class="fas fa-info-circle info-icon" data-tool="vdspc_license"></i></label>
            </div>
            </div>
            <div class="checkbox-containerpr">
            <div class="checkbox-itempr">
                <input type="checkbox" name="vdspcHardware" value="server">
                <label>Server <i class="fas fa-info-circle info-icon" data-tool="vdspc_server"></i></label>
            </div>
            </div>
            <div class="requirementpr">V-One </div>
            <div class="checkbox-containerpr">
            <div class="checkbox-itempr">
                <input type="checkbox" name="voneSoftware" value="license">
                <label>License <i class="fas fa-info-circle info-icon" data-tool="vone_license"></i></label>
            </div>
            </div>
            <div class="checkbox-containerpr">
            <div class="checkbox-itempr">
                <input type="checkbox" name="voneHardware" value="server">
                <label>Server <i class="fas fa-info-circle info-icon" data-tool="vone_server"></i></label>
            </div>
            </div>
            <div class="requirementpr">V-Accelerator </div>
            <div class="checkbox-containerpr">
            <div class="checkbox-itempr">
                <input type="checkbox" name="vAcceleratorSoftware" value="license_dongle">
                <label>License / dongle <i class="fas fa-info-circle info-icon" data-tool="v_acc_license"></i></label>
            </div>
            </div>
            <div class="checkbox-containerpr"></div>
            <div class="requirementpr">V-Tune </div>
            <div class="checkbox-containerpr">
            <div class="checkbox-itempr">
                <input type="checkbox" name="vTuneSoftware" value="system_gt_32gb_ram">
                <label>System &gt;32GB RAM <i class="fas fa-info-circle info-icon" data-tool="v_tune_system32"></i></label>
            </div>
            </div>
            <div class="checkbox-containerpr"></div>
            <div class="requirementpr">Minitab </div>
            <div class="checkbox-containerpr">
            <div class="checkbox-itempr">
                <input type="checkbox" name="minitabSoftware" value="license">
                <label>License <i class="fas fa-info-circle info-icon" data-tool="minitab_license"></i></label>
            </div>
            </div>
            <div class="checkbox-containerpr">
            <div class="checkbox-itempr">
                <input type="checkbox" name="minitabHardware" value="server">
                <label>Server <i class="fas fa-info-circle info-icon" data-tool="minitab_server"></i></label>
            </div>
            <div class="checkbox-itempr">
                <input type="checkbox" name="minitabHardware" value="additional_gt_500gb_drive">
                <label>Additional &gt;500GB hard drive capacity <i class="fas fa-info-circle info-icon" data-tool="minitab_500gb"></i></label>
            </div>
            </div>
            <div class="requirementpr">One-View </div>
            <div class="checkbox-containerpr">
            <div class="checkbox-itempr">
                <input type="checkbox" name="oneViewSoftware" value="license">
                <label>License <i class="fas fa-info-circle info-icon" data-tool="one_view_license"></i></label>
            </div>
            </div>
            <div class="checkbox-containerpr">
            <div class="checkbox-itempr">
                <input type="checkbox" name="oneViewHardware" value="additional_gt_500gb_drive_16gb_ram">
                <label>Additional &gt;500GB Drive, Additional 16GB RAM <i class="fas fa-info-circle info-icon" data-tool="one_view_drive_ram"></i></label>
            </div>
            </div>
            <div class="requirementpr">MES </div>
            <div class="checkbox-containerpr">
            <div class="checkbox-itempr">
                <input type="checkbox" name="mesSoftware" value="available_feature">
                <label>Available feature <i class="fas fa-info-circle info-icon" data-tool="mes_available"></i></label>
            </div>
            </div>
            <div class="checkbox-containerpr">
            <div class="checkbox-itempr">
                <input type="checkbox" name="mesHardware" value="need_to_develop_enhance">
                <label>Need to develop/enhance <i class="fas fa-info-circle info-icon" data-tool="mes_develop"></i></label>
            </div>
            </div>
            <div class="requirementpr">Barcode related </div>
            <div class="checkbox-containerpr">
            <div class="checkbox-itempr">
                <input type="checkbox" name="barcodeSoftware" value="available_feature">
                <label>Available feature <i class="fas fa-info-circle info-icon" data-tool="barcode_available"></i></label>
            </div>
            </div>
            <div class="checkbox-containerpr">
            <div class="checkbox-itempr">
                <input type="checkbox" name="barcodeHardware" value="need_to_develop_enhance">
                <label>Need to develop/enhance <i class="fas fa-info-circle info-icon" data-tool="barcode_develop"></i></label>
            </div>
            </div>
        </div>
        </div>

        <!-- Section 9 -->
        <div class="form-section">
            <div class="section-title">9. HARDWARE</div>
            <div class="checkbox-grid-xc">
                <div class="requirement-xc">Rubber pad version 2019 :</div>
                <div class="checkbox-options-xc">
                    <label><input type="checkbox" name="rubberPad" value="smaller_than_0201">Component smaller than 0201</label>
                </div>
            </div>
        </div>

        <!-- Section 10 -->
        <div class="form-section">
            <div class="section-title">10. TOOLS</div>
                <div class="checkbox-options-xc">
                    <label><input type="checkbox" name="tools" value="leveling_meter">Leveling meter</label>
                    <label><input type="checkbox" name="tools" value="auto_3d_calibration_jig">Auto 3D Calibration Jig</label>
                    <label><input type="checkbox" name="tools" value="manual_3d_calibration_jig">Manual 3D Calibration Jig</label>
                    <label><input type="checkbox" name="tools" value="a4_grey_card">A4 Grey Card</label>
                    <label><input type="checkbox" name="tools" value="fiducial_plate">Fiducial Plate</label>
                    <label><input type="checkbox" name="tools" value="barcode_reader">Barcode reader</label>
                    <label><input type="checkbox" name="tools" value="300um_3d_step_grr_jig">300um 3D step GRR jig</label>
                    <label><input type="checkbox" name="tools" value="customized_rubber_pad">Customized Rubber pad</label>
                    <label><input type="checkbox" name="tools" value="torque_wrench">Torque wrench</label>
                    <label><input type="checkbox" name="tools" value="aoi_machine_stand_40mm_extension_block">AOI Machine Stand 40mm Extension Block</label>
                </div>
            </div>

        <!-- Section 11 -->
        <div class="form-section">
            <div class="section-title">11. Customers' Current Top Issues</div>
            <div class="table-section">
                <table class="eval-table" id="custIssueTable">
                    <thead>
                        <tr>
                        <th>#</th>
                        <th>Issue Description</th>
                        </tr>
                    </thead>
                    <tbody id="custIssueTableBody">
                        <tr>
                        <td class="row-number">1</td>
                        <td class="issue-row-content">
                            <input type="text" name="custIssues[]" class="issue-input" required>
                            <button type="button" class="delete-row-btn" onclick="deleteIssueRow(this)" style="display: none;">&times;</button>
                        </td>
                        </tr>
                    </tbody>
                    </table>
                    <button type="button" class="add-row-btn" onclick="addIssueRow()">+ Add Issue</button>
            </div>
        </div>

        <!-- Attachment Section -->
        <div class="form-section">
            <div class="section-title">Attachment</div>
            <div class="form-group-evalxc">
                <label>Upload File (Optional)</label>
                <div style="font-size: 0.85em; color: #666; margin-bottom: 10px;">
                    Please upload the file in PNG or PDF only
                </div>
                <input type="file" id="attachmentInput" accept=".png,.pdf,image/png,application/pdf" style="margin-bottom: 10px;">
                <div id="attachmentPreview" style="margin-top: 10px;"></div>
            </div>
        </div>

        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="goBack()">Back</button>
            <button type="button" class="btn btn-primary draft-btn" onclick="saveForm('draft')" id="saveProgressBtn">Save as Draft</button>
            <button type="submit" class="btn btn-success submit-btn" id="submitBtn">Submit</button>
        </div>
    </form>
</div>
<div id="tooltip" class="tooltip"></div>

<script>
const client = new Appwrite.Client()
    .setEndpoint("https://fra.cloud.appwrite.io/v1")
    .setProject("68ddd7de00255d4f5c96");

const databases = new Appwrite.Databases(client);
const account = new Appwrite.Account(client);
const storage = new Appwrite.Storage(client);

const databaseId = "68ba8a9c001f17064e15";
const collectionId = "68ba918c0022d2b9a429";
const preEvalCollectionId = "68c7ced6001bd14d08f4";
const referenceCollectionId = "68da1d5f002142be75df";
const bucketId = "69015d8b0030f329c599";

const params = new URLSearchParams(window.location.search);
const eventId = params.get("id"); 
const viewMode = params.get("mode") === "view";

let currentUser = null;
let formData = null;
let referenceDocData = null;
let uploadedFileId = null;
let currentStatus = "draft";
let referenceData = {};

async function initForm() {
    try {
        currentUser = await account.get();
        console.log("Current user:", currentUser);
        
        if (!eventId) {
            alert("No event ID found. Please start from the Details page.");
            window.location.href = "/createform.html";
            return;
        }

        await loadExistingForm();
        if (viewMode) setViewMode();
    } catch (error) {
        console.error("Error initializing form:", error);
        alert("Error loading form. Redirecting to dashboard.");
        window.location.href = "/createform.html";
    }
}

async function loadExistingForm() {
    try {
        document.getElementById("loadingIndicator").style.display = "block";
        try {
            referenceDocData = await databases.getDocument(databaseId, collectionId, eventId);
            console.log("Loaded reference data from main collection:", referenceDocData);
        } catch (err) {
            console.log("Reference document not found in main collection:", err);
        }
        try {
            formData = await databases.getDocument(databaseId, preEvalCollectionId, eventId);
            console.log("Loaded pre-eval form data:", formData);
        } catch (err) {
            console.log("Pre-eval form not found, will create new one:", err);
        }
        populateForm(formData, referenceDocData);
        currentStatus = (formData && formData.status) || "draft";
        
        updateFormDisplay();
        document.getElementById("loadingIndicator").style.display = "none";
        document.getElementById("preEvalForm").style.display = "block";
    } catch (error) {
        console.log("Error loading form:", error);
        document.getElementById("loadingIndicator").style.display = "none";
        document.getElementById("preEvalForm").style.display = "block";
        updateFormDisplay();
    }
}

function populateForm(preEvalData, referenceData) {
    const data = preEvalData || {};
    const customerCompanyElement = document.getElementById('customerCompany');
    if (customerCompanyElement) {
        if (referenceData && referenceData.customerCompany) {
            customerCompanyElement.value = referenceData.customerCompany;
            console.log("Populated company from reference data:", referenceData.customerCompany);
        } else if (data.customerCompany) {
            customerCompanyElement.value = data.customerCompany;
        }
    }
    
    if (data.attachmentId) {
        uploadedFileId = data.attachmentId;
        try {
            const fileUrl = storage.getFileView(bucketId, data.attachmentId);
            const fileName = data.attachmentName || 'Uploaded file';
            document.getElementById('attachmentPreview').innerHTML = `
                <div style="display: flex; align-items: center; padding: 10px; background: #f5f5f5; border-radius: 5px;">
                    <span style="flex: 1;">${fileName}</span>
                    <a href="${fileUrl}" target="_blank" style="margin-right: 10px; color: #007bff; text-decoration: none;">View</a>
                    ${!viewMode ? '<button type="button" onclick="removeAttachment()" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Remove</button>' : ''}
                </div>
            `;
        } catch (error) {
            console.error('Error loading attachment:', error);
        }
    }

    const textFields = [
        'custTechChamp', 'competitor', 'compModel',
        'scpsalesChamp', 'scptechChamp', 'vitroxsalesChamp', 'vitroxtechChamp',
        'cycleTime', 'falseCallppm', 'otherreq'
    ];

    textFields.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element && data[fieldId]) element.value = data[fieldId];
    });

    const selectFields = ['existcust', 'venue', 'inspectionEnvironment', 'fpyTarget', 'prodseg', 'reqinspect', 'boardStopRequirement', 'coaxialLighting'];
    selectFields.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element && data[fieldId]) element.value = data[fieldId];
    });

    const dateFields = ['evalDate'];
    dateFields.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element && data[fieldId]) {
            element.value = new Date(data[fieldId]).toISOString().split("T")[0];
        }
    });

    const checkboxGroups = [
        'boardThickness', 'smallestComponentSize', 'inspectionRequirement', 'programmingInputFiles',
        'conveyor', 'machineTypeByBoardSize', 'boardFlowDirection', 'lens', 'hardiscCapacity',
        'rubberPad', 'tools'
    ];

    checkboxGroups.forEach(groupName => {
        if (data[groupName] && Array.isArray(data[groupName])) {
            data[groupName].forEach(value => {
                const checkbox = document.querySelector(`input[name="${groupName}"][value="${value}"]`);
                if (checkbox) checkbox.checked = true;
            });
        }
    });

    const featureFields = [
        'vLibrarySoftware', 'vLibraryHardware', 'aiProgrammingSoftware', 'aiProgrammingHardware',
        'vvtsSoftware', 'vvtsHardware', 'aiVvtsSoftware', 'aiVvtsHardware',
        'vdspcSoftware', 'vdspcHardware', 'voneSoftware', 'voneHardware',
        'vAcceleratorSoftware', 'vTuneSoftware', 'minitabSoftware', 'minitabHardware',
        'oneViewSoftware', 'oneViewHardware', 'mesSoftware', 'mesHardware',
        'barcodeSoftware', 'barcodeHardware'
    ];

    featureFields.forEach(fieldName => {
        if (data[fieldName] && Array.isArray(data[fieldName])) {
            data[fieldName].forEach(value => {
                const checkbox = document.querySelector(`input[name="${fieldName}"][value="${value}"]`);
                if (checkbox) checkbox.checked = true;
            });
        }
    });

    if (data.custIssues && data.custIssues.length > 0) {
        const tbody = document.getElementById("custIssueTableBody");
        tbody.innerHTML = "";
        
        data.custIssues.forEach((issue, index) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td class="row-number">${index + 1}</td>
                <td class="issue-row-content">
                    <input type="text" name="custIssues[]" class="issue-input" value="${issue}" required>
                    <button type="button" class="delete-row-btn" onclick="deleteIssueRow(this)" ${data.custIssues.length > 1 ? '' : 'style="display: none;"'}>&times;</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
}

function setViewMode() {
    const form = document.getElementById("preEvalForm");
    const inputs = form.querySelectorAll('input, textarea, select, button[type="submit"], button[type="button"]:not(.btn-secondary)');
    inputs.forEach(input => {
        if (input.type === 'submit' || input.classList.contains('add-row-btn') || input.classList.contains('draft-btn')) {
            input.style.display = 'none';
        } else if (input.type === 'file') {
            input.style.display = 'none';
        } else {
            input.disabled = true;
        }
    });
    document.getElementById("formTitle").textContent = "Pre-Evaluation Form (View Mode)";
}

function goBack() {
  window.history.back();
}

function updateFormDisplay() {
    const statusBadge = document.getElementById("statusBadge");
    const formTitle = document.getElementById("formTitle");
    const submitBtn = document.getElementById("submitBtn");
    const saveProgressBtn = document.getElementById("saveProgressBtn");
    
    statusBadge.textContent = currentStatus;
    statusBadge.className = `status-badge ${currentStatus.replace(/\s+/g, '-').toLowerCase()}`;
    
    if (viewMode) {
        formTitle.textContent = `Pre-Evaluation Form (Viewing)`;
        document.querySelectorAll('input, textarea, select, button[type="button"]:not(.btn-secondary)').forEach(el => el.disabled = true);
        if (submitBtn) submitBtn.style.display = 'none';
        if (saveProgressBtn) saveProgressBtn.style.display = 'none';
    } else {
        formTitle.textContent = `Pre-Evaluation Form`;
        if (currentStatus === "complete" && submitBtn) {
            submitBtn.style.display = 'none';
        }
    }
}

function addIssueRow() {
    const tbody = document.getElementById("custIssueTableBody");
    const rowCount = tbody.rows.length;
    const row = document.createElement("tr");
    row.innerHTML = `
        <td class="row-number">${rowCount + 1}</td>
        <td class="issue-row-content">
            <input type="text" name="custIssues[]" class="issue-input" required>
            <button type="button" class="delete-row-btn" onclick="deleteIssueRow(this)">&times;</button>
        </td>
    `;
    tbody.appendChild(row);
    updateDeleteButtons();
}

function deleteIssueRow(btn) {
    const tbody = document.getElementById("custIssueTableBody");
    if (tbody.rows.length > 1) {
        btn.closest('tr').remove();
        updateRowNumbers();
        updateDeleteButtons();
    }
}

function updateRowNumbers() {
    const tbody = document.getElementById("custIssueTableBody");
    Array.from(tbody.rows).forEach((row, index) => {
        row.querySelector('.row-number').textContent = index + 1;
    });
}

function updateDeleteButtons() {
    const tbody = document.getElementById("custIssueTableBody");
    const deleteButtons = tbody.querySelectorAll('.delete-row-btn');
    deleteButtons.forEach(btn => {
        btn.style.display = tbody.rows.length > 1 ? 'inline-block' : 'none';
    });
}

function collectFormData() {
    const data = {};

    const textFields = [
        'customerCompany', 'custTechChamp', 'competitor', 'compModel',
        'scpsalesChamp', 'scptechChamp', 'vitroxsalesChamp', 'vitroxtechChamp',
        'cycleTime', 'falseCallppm', 'otherreq'
    ];

    textFields.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element) data[fieldId] = element.value.trim();
    });

    const selectFields = ['existcust', 'venue', 'inspectionEnvironment', 'fpyTarget', 'prodseg', 'reqinspect', 'boardStopRequirement', 'coaxialLighting'];
    selectFields.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element) data[fieldId] = element.value;
    });

    ['evalDate'].forEach(dateField => {
        const element = document.getElementById(dateField);
        if (element && element.value) {
            data[dateField] = new Date(element.value + "T00:00:00Z").toISOString();
        }
    });

    const checkboxGroups = [
        'boardThickness', 'smallestComponentSize', 'inspectionRequirement', 'programmingInputFiles',
        'conveyor', 'machineTypeByBoardSize', 'boardFlowDirection', 'lens', 'hardiscCapacity',
        'rubberPad', 'tools'
    ];
    checkboxGroups.forEach(groupName => {
        const checkedBoxes = document.querySelectorAll(`input[name="${groupName}"]:checked`);
        if (checkedBoxes.length > 0) {
            data[groupName] = Array.from(checkedBoxes).map(cb => cb.value);
        }
    });

    const featureFields = [
        'vLibrarySoftware', 'vLibraryHardware', 'aiProgrammingSoftware', 'aiProgrammingHardware',
        'vvtsSoftware', 'vvtsHardware', 'aiVvtsSoftware', 'aiVvtsHardware',
        'vdspcSoftware', 'vdspcHardware', 'voneSoftware', 'voneHardware',
        'vAcceleratorSoftware', 'vTuneSoftware', 'minitabSoftware', 'minitabHardware',
        'oneViewSoftware', 'oneViewHardware', 'mesSoftware', 'mesHardware',
        'barcodeSoftware', 'barcodeHardware'
    ];

    featureFields.forEach(fieldName => {
        const checkedBoxes = document.querySelectorAll(`input[name="${fieldName}"]:checked`);
        if (checkedBoxes.length > 0) {
            data[fieldName] = Array.from(checkedBoxes).map(cb => cb.value);
        }
    });

    const issueInputs = document.querySelectorAll('[name="custIssues[]"]');
    const custIssues = Array.from(issueInputs)
        .map(input => input.value.trim())
        .filter(value => value !== '');
    if (custIssues.length > 0) {
        data.custIssues = custIssues;
    }

    return data;
}

async function saveForm(status = "draft") {
    try {
        const collectedData = collectFormData();
        const fileInput = document.getElementById('attachmentInput');
        
        if (fileInput && fileInput.files.length > 0) {
            const fileId = await uploadFile();
            if (fileId) {
                uploadedFileId = fileId;
            }
        }

        if (status === "complete") {
            const requiredFields = [
                'customerCompany', 'custTechChamp', 'evalDate','scpsalesChamp', 'scptechChamp',
                'vitroxsalesChamp', 'vitroxtechChamp', 'venue'
            ];
            
            const missingFields = requiredFields.filter(field => !collectedData[field] || collectedData[field].trim() === '');
            if (missingFields.length > 0 || !collectedData.custIssues || collectedData.custIssues.length === 0) {
                alert("Please fill in all required fields before submitting.");
                return;
            }
        }
        
        const saveData = {
            ...collectedData,
            status: status
        };
        
        if (uploadedFileId) {
            saveData.attachmentId = uploadedFileId;
            if (fileInput && fileInput.files.length > 0) {
                saveData.attachmentName = fileInput.files[0].name;
            } else if (formData && formData.attachmentName) {
                saveData.attachmentName = formData.attachmentName;
            }
        }
        
        for (const key in saveData) {
            if (Array.isArray(saveData[key])) {
                saveData[key] = saveData[key].filter(v => v !== "" && v !== null && v !== undefined);
                if (saveData[key].length === 0) delete saveData[key];
            }
        }
        
        const enumFields = ["existcust", "venue", "inspectionEnvironment", "fpyTarget", "prodseg", "reqinspect", "boardStopRequirement", "coaxialLighting"];
        enumFields.forEach(field => {
            if (saveData[field] === "") delete saveData[field];
        });

        console.log("Data to save:", saveData);

        try {
            await databases.updateDocument(databaseId, preEvalCollectionId, eventId, saveData);
            console.log("Form updated successfully");
        } catch (updateError) {
            if (updateError.message.includes("Document with the requested ID could not be found")) {
                await databases.createDocument(databaseId, preEvalCollectionId, eventId, saveData);
                console.log("Form created successfully with event ID:", eventId);
            } else {
                console.error("Error updating document:", updateError);
                throw updateError;
            }
        }

        currentStatus = status;
        updateFormDisplay();
        alert(status === "complete" ? "Form submitted successfully!" : "Form saved as draft!");
        window.location.href = `detail.html?id=${eventId}`;

    } catch (error) {
        console.error("Error saving form:", error);
        alert(`Error saving form: ${error.message}. Please try again.`);
    }
}

async function loadReferenceData() {
  try {
    const response = await databases.listDocuments(databaseId, referenceCollectionId);
    response.documents.forEach(doc => {
      referenceData[doc.referenceId] = {
        options: doc.options || [],   
        detail: doc.detail || []     
      };
    });
  } catch (error) {
    console.log("No reference data found:", error);
  }
}

function initTooltips() {
  const tooltip = document.getElementById('tooltip');
  const infoIcons = document.querySelectorAll('.info-icon');

  infoIcons.forEach(icon => {
    icon.addEventListener('click', function(e) {
      e.stopPropagation();
      const toolId = this.getAttribute('data-tool');
      showTooltip(e, toolId);
    });
  });

  document.addEventListener('click', () => {
    tooltip.classList.remove('active');
  });
}

function showTooltip(event, toolId) {
  const tooltip = document.getElementById('tooltip');
  const ref = referenceData[toolId];

  if (ref) {
    let listHtml = "";

    const maxLen = Math.max(ref.options.length, ref.detail.length);
    for (let i = 0; i < maxLen; i++) {
      const opt = ref.options[i] || "-";
      const det = ref.detail[i] || "-";
      listHtml += `<li><strong>${opt}</strong> : ${det}</li>`;
    }

    tooltip.innerHTML = `
      <div style="font-weight:600; margin-bottom:6px;">Available Options</div>
      <ul style="padding-left:18px; margin:0;">${listHtml}</ul>
    `;
  } else {
    tooltip.textContent = "No option available";
  }

  const rect = event.target.getBoundingClientRect();
  const scrollTop = window.scrollY || document.documentElement.scrollTop;
  const scrollLeft = window.scrollX || document.documentElement.scrollLeft;

  tooltip.style.top = (rect.bottom + scrollTop + 10) + 'px';
  tooltip.style.left = (rect.left + scrollLeft) + 'px';
  tooltip.classList.add('active');
}

function showToast(message, isError = false) {
    const existingToast = document.querySelector('.toast-notification');
    if (existingToast) {
        existingToast.remove();
    }
    
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: ${isError ? '#f44336' : '#4CAF50'};
        color: white;
        padding: 12px 24px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 2000);
}

function initFileUpload() {
    const fileInput = document.getElementById('attachmentInput');
    if (fileInput) {
        fileInput.addEventListener('change', handleFileSelect);
    }
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    const validTypes = ['image/png', 'application/pdf'];
    if (!validTypes.includes(file.type)) {
        alert('Please upload only PNG or PDF files.');
        event.target.value = '';
        return;
    }

    const maxSize = 10 * 1024 * 1024;
    if (file.size > maxSize) {
        alert('File size must be less than 10MB.');
        event.target.value = '';
        return;
    }

    displayFilePreview(file);
}

function displayFilePreview(file) {
    const preview = document.getElementById('attachmentPreview');
    preview.innerHTML = `
        <div style="display: flex; align-items: center; padding: 10px; background: #f5f5f5; border-radius: 5px;">
            <span style="flex: 1;">${file.name} (${(file.size / 1024).toFixed(2)} KB)</span>
            <button type="button" onclick="removeAttachment()" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Remove</button>
        </div>
    `;
}

function removeAttachment() {
    document.getElementById('attachmentInput').value = '';
    document.getElementById('attachmentPreview').innerHTML = '';
    uploadedFileId = null;
}

async function uploadFile() {
    const fileInput = document.getElementById('attachmentInput');
    const file = fileInput.files[0];
    
    if (!file) return null;

    try {
        showToast('Uploading file...');
        const response = await storage.createFile(
            bucketId,
            'unique()',
            file
        );
        uploadedFileId = response.$id;
        showToast('File uploaded successfully!');
        return response.$id;
    } catch (error) {
        console.error('File upload error:', error);
        showToast('Failed to upload file', true);
        return null;
    }
}

document.addEventListener("DOMContentLoaded", async () => {
    await initForm();
    await loadReferenceData();  
    initTooltips();
    initFileUpload();

document.getElementById("preEvalForm").addEventListener("submit", e => {
    e.preventDefault();
    saveForm("complete");
});
});

</script>

<footer class="footer">
    <span>Â© 2025 ViTrox. All rights reserved.</span>
</footer>

</body>

</html>



