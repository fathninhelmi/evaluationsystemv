<!DOCTYPE html>
<html lang="en">
<head>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="./style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0/dist/iife/sdk.js"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Create Evaluation Form</title>
</head>
<body>

<header class="header">
    <a href="#" class="logo"><img src="logo.png" alt="logo"></a>
    <nav class="nav-desktop">
        <a href="staff.html" class="nav-link">Home</a>
        <a href="createform.html" class="nav-link active">Create Form</a>
        <a href="notifications.html" class="nav-link">Notifications</a>
        <a href="index.html" class="nav-link" id="logoutBtn">Logout</a>
    </nav>
</header>

<div class="container">
  <h1>Create Evaluation Form</h1>
  <form id="eventForm">
    <div class="form-sectioncr two-column">
      <div class="form-group">
        <select id="productType" required>
          <option value="" disabled selected>Select Product Type</option>
          <option value="SPI">SPI</option>
          <option value="AOI">AOI</option>
          <option value="AXI">AXI</option>
          <option value="ARV">ARV</option>
          <option value="XC">Smart Camera (XC)</option>
          <option value="XS">Smart Code Reader (XS)</option>
        </select>
      </div>

      <div class="form-group" id="productCategoryGroup" style="display: none;">
        <select id="productCategory" required>
          <option value="" disabled selected>Select Product Category</option>
        </select>
      </div>

    <div class="form-group">
      <select id="eventName" required>
        <option value="" disabled selected>Select product name</option>
      </select>
    </div>
        
      <div class="form-group">
        <input type="text" id="customerCompany" placeholder="Enter customer company name" required>
      </div>
      <div class="form-group">
        <input type="text" id="customerLocation" placeholder="e.g., Bayan Lepas, Penang, Malaysia" required>
        <div class="location-hint">üí° <strong>Important:</strong> Enter the specific area/city where the company is located (e.g., "Bayan Lepas, Penang" or "Kulim Hi-Tech Park, Kedah"). The system will combine this with the company name for accurate mapping.</div>
        <div id="locationPreview" class="location-preview"></div>
      </div>
      <button type="submit" class="btn" style="grid-column: span 2;">Create Form</button>
    </div>
  </form>

  <h2>All Evaluation Forms</h2>
  <div id="eventsList"><p>Loading...</p></div>
</div>

<script type="module">
const { Client, Account, Databases, Query, ID } = window.Appwrite;
const client = new Client();
client.setEndpoint("https://fra.cloud.appwrite.io/v1")
.setProject("68ddd7de00255d4f5c96");

const account = new Account(client);
const databases = new Databases(client);

const databaseId = "68ba8a9c001f17064e15";
const collectionId = "68ba918c0022d2b9a429";
const preEvalCollectionIds = {
  'AOI': '68c7ced6001bd14d08f4',
  'SPI': '696dd2b1000c4e985d76',
  'AXI': '696ed4b900377582df31',
  'ARV': '696dd29b0034536c09b9', 
  'XC': '696dd2f20006c0eef2a1',  
  'XS': '696dd301001cd0f6da66'  
};
const evalCollectionId = "68bf9d5600257a20775a";
const postEvalCollectionId = "68bf9d62002b4f5f7f23";

let currentUser = null;
let geocodeTimeout = null;

 const productCategoryOptions = {
  'SPI': [
    { value: 'semiconspi', label: 'Back-end Semiconductor' },
    { value: 'smtspi', label: 'SMT PCB Assembly' }
  ],
  'AOI': [
    { value: 'semiconaoi', label: 'Back-end Semiconductor' },
    { value: 'smtaoi', label: 'SMT PCB Assembly' },
    { value: 'finalAssembly', label: 'Final Assembly' }
  ],
  'AXI': [
    { value: 'highspeed', label: 'High-Speed' },
    { value: 'highresolution', label: 'High-Resolution' }
  ],
  'ARV': [
    { value: 'speedinline', label: 'High Speed Inline System' },
    { value: 'flexibilityoffline', label: 'High Flexibility Offline System' }
  ]
};

const productNameOptions = {
  'AXI': [
    'V810Ai S3',
    'V810Ai S2 XLL',
    'V810Ai S2 XLT M',
    'V810Ai S2 XLT',
    'V810Ai S2 XLW',
    'V810Ai QX1',
    'V810i S2 EX'
  ],
  'ARV': [
    'V9i Coating Inspection (CI)',
    'V9i Final Inspection (FI)'
  ],
  'AOI': [
    'V510i Optimus 3D',
    'V510i XL',
    'V510i XXL',
    'V510i OP XXL',
    'V510i XLW',
    'V510i SE',
    'V510i SE XXL',
    'V510Ai ST',
    'V510Ai DST',
    'V510i R',
    'AOI for Advanced Packaging and Microelectronics'
  ],
  'SPI': [
    'V310i Optimus 3D',
    'V310i XL',
    'V310i XXL',
    'V310i OP XXL',
    'V310i SE',
    'V310i SE XXL',
    'SPI for Advanced Packaging and Microelectronics'
  ],
  'XC': [],
  'XS': []
};

document.getElementById("productType").addEventListener("change", (e) => {
  const productType = e.target.value;
  const categoryGroup = document.getElementById("productCategoryGroup");
  const categorySelect = document.getElementById("productCategory");
  
  if (productCategoryOptions[productType]) {
    categoryGroup.style.display = "block";
    categorySelect.innerHTML = `<option value="" disabled selected>Select ${productType} Product Category</option>`;
    
    productCategoryOptions[productType].forEach(option => {
      const optionEl = document.createElement("option");
      optionEl.value = option.value;
      optionEl.textContent = option.label;
      categorySelect.appendChild(optionEl);
    });
    
    categorySelect.required = true;
  } else {
    categoryGroup.style.display = "none";
    categorySelect.required = false;
    categorySelect.innerHTML = '<option value="" disabled selected>Select Product Category</option>';
  }

    const eventNameSelect = document.getElementById("eventName");
  if (productNameOptions[productType] && productNameOptions[productType].length > 0) {
    eventNameSelect.innerHTML = `<option value="" disabled selected>Select ${productType} Product Name</option>`;
    
    productNameOptions[productType].forEach(name => {
      const optionEl = document.createElement("option");
      optionEl.value = name;
      optionEl.textContent = name;
      eventNameSelect.appendChild(optionEl);
    });
  } else {
    eventNameSelect.innerHTML = `<option value="" disabled selected>Select ${productType} Product Name</option>`;
  }
});

document.getElementById("customerLocation").addEventListener("input", (e) => {
  clearTimeout(geocodeTimeout);
  const preview = document.getElementById("locationPreview");
  
  geocodeTimeout = setTimeout(async () => {
    const location = e.target.value.trim();
    if (location.length > 3) {
      preview.innerHTML = "üîç Checking location...";
      preview.classList.add("active");
      
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&limit=1`);
        const data = await res.json();
        
        if (data && data.length > 0) {
          preview.innerHTML = `‚úÖ Found: ${data[0].display_name}`;
          preview.style.background = "#d4edda";
          preview.style.color = "#155724";
        } else {
          preview.innerHTML = "‚ö†Ô∏è Location not found. Please be more specific.";
          preview.style.background = "#fff3cd";
          preview.style.color = "#856404";
        }
      } catch (err) {
        preview.innerHTML = "‚ùå Could not verify location";
        preview.style.background = "#f8d7da";
        preview.style.color = "#721c24";
      }
    } else {
      preview.classList.remove("active");
    }
  }, 1000);
});

async function getOverallStatus(eventId, productType) {
  const preEvalCollectionId = preEvalCollectionIds[productType];

  const isXCorXS = productType === 'XC' || productType === 'XS';
  
  const statuses = await Promise.all([
    getFormStatus(preEvalCollectionId, eventId),
    isXCorXS ? Promise.resolve(null) : getFormStatus(evalCollectionId, eventId),
    getFormStatus(postEvalCollectionId, eventId)
  ]);

  const [preStatus, evalStatus, postStatus] = statuses;

  if (preStatus === "drop" || evalStatus === "drop" || postStatus === "drop") {
    return { status: "drop", color: "#8B949E", order: 4 };
  }

  if (isXCorXS) {
    if (preStatus === "complete" && postStatus === "complete") {
      return { status: "complete", color: "#2a9d8f", order: 3 };
    }
    
    if (preStatus !== "draft" || postStatus !== "draft") {
      return { status: "in progress", color: "#f4a261", order: 2 };
    }
    
    return { status: "draft", color: "#e76f51", order: 1 };
  }

  if (preStatus === "complete" && evalStatus === "complete" && postStatus === "complete") {
    return { status: "complete", color: "#2a9d8f", order: 3 };
  }

  if (preStatus !== "draft" || evalStatus !== "draft" || postStatus !== "draft") {
    return { status: "in progress", color: "#f4a261", order: 2 };
  }

  return { status: "draft", color: "#e76f51", order: 1 };
}

async function getFormStatus(collectionId, eventId) {
  try {
    const doc = await databases.getDocument(databaseId, collectionId, eventId);
    return doc.status || "draft";
  } catch (err) {
    if (err.message.includes("Document with the requested ID could not be found")) {
      return "draft"; 
    }
    console.warn("Error checking form status:", err);
    return "draft";
  }
}

async function loadForms() {
  const list = document.getElementById("eventsList");
  list.innerHTML = "<p>Loading...</p>";

  try {
    const res = await databases.listDocuments(databaseId, collectionId, [
      Query.equal("email", currentUser.email),
      Query.limit(100),
      Query.orderDesc("$createdAt")
    ]);

    if (res.documents.length === 0) {
      list.innerHTML = "<p>No evaluation forms yet.</p>";
      return;
    }

    const formsWithStatus = await Promise.all(
      res.documents.map(async (doc) => {
        const statusInfo = await getOverallStatus(doc.$id, doc.productType);
        return { doc, statusInfo };
      })
    );
      
    formsWithStatus.sort((a, b) => a.statusInfo.order - b.statusInfo.order);

    list.innerHTML = "";

    for (const { doc, statusInfo } of formsWithStatus) {
      const div = document.createElement("div");
      div.className = "event-item";

      div.style.backgroundColor = statusInfo.color;
      div.style.color = "white";
      div.style.padding = "10px";
      div.style.marginBottom = "8px";
      div.style.borderRadius = "5px";
      div.style.display = "flex";
      div.style.justifyContent = "space-between";
      div.style.alignItems = "center";

      const infoDiv = document.createElement("div");
      infoDiv.style.flex = "1";
      infoDiv.style.cursor = "pointer";
      infoDiv.onclick = () => window.location.href = `detail.html?id=${doc.$id}`;
      
      infoDiv.innerHTML = `
        <div><strong>${doc.prodname || "Untitled"}</strong></div>
        <div style="font-size:12px;opacity:0.9;">
          üìÖ ${formatDate(doc.createDate)} | 
          üè¢ ${doc.customerCompany} | 
          üìç ${doc.customerLocation}
        </div>
      `;

      const delBtn = document.createElement("button");
      delBtn.className = "delete-btn";
      delBtn.innerHTML = '<i class="fas fa-trash"></i>';
      delBtn.onclick = async (e) => {
        e.stopPropagation();
        if (confirm(`Delete '${doc.prodname}'?`)) {
          try {
            await databases.deleteDocument(databaseId, collectionId, doc.$id);
            const correctPreEvalId = preEvalCollectionIds[doc.productType];
              if (correctPreEvalId) {
                try { await databases.deleteDocument(databaseId, correctPreEvalId, doc.$id); } catch {}
              }
            try { await databases.deleteDocument(databaseId, evalCollectionId, doc.$id); } catch {}
            try { await databases.deleteDocument(databaseId, postEvalCollectionId, doc.$id); } catch {}
            loadForms();
          } catch (err) {
            alert("Failed to delete form");
            console.error(err);
          }
        }
      };
      const badge = document.createElement("span");
      badge.className = `status-badge status-${statusInfo.status.replace(" ", "")}`;
      badge.textContent = statusInfo.status;
      
      div.appendChild(infoDiv);
      div.appendChild(badge); 
      div.appendChild(delBtn);
      list.appendChild(div);
    }

  } catch (err) {
    console.error("Error loading forms:", err);
    list.innerHTML = "<p>Failed to load forms.</p>";
  }
}

function formatDate(dateStr) {
  const d = new Date(dateStr);
  return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
}

document.getElementById("logoutBtn").addEventListener("click", async (e) => {
  e.preventDefault();
  try {
    await account.deleteSession("current");
    window.location.href = "index.html";
  } catch (err) {
    console.error("Logout failed:", err);
    window.location.href = "index.html";
  }
});

document.addEventListener("DOMContentLoaded", async () => {
  try {
    currentUser = await account.get();
    loadForms();
  } catch (err) {
    console.error("Failed to get user:", err);
    alert("You must be logged in");
    window.location.href = "index.html";
  }
});

document.getElementById("eventForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const productType = document.getElementById("productType").value;
  const productCategory = document.getElementById("productCategory").value;
  const eventName = document.getElementById("eventName").value.trim();
  const customerCompany = document.getElementById("customerCompany").value.trim();
  const customerLocation = document.getElementById("customerLocation").value.trim();

  if (!productType || !eventName || !customerCompany || !customerLocation) {
    alert("Please fill out all fields");
    return;
  }

  if (productCategoryOptions[productType] && !productCategory) {
    alert("Please select a product category");
    return;
  }

  try {
    const formData = {
      productType,
      prodname: eventName,
      customerCompany,
      customerLocation,
      username: currentUser.name || currentUser.email,
      email: currentUser.email,
      createDate: new Date().toISOString(),
      status: "draft"
    };

    if (productCategory) {
      formData.productCategory = productCategory;
    }

    const mainForm = await databases.createDocument(databaseId, collectionId, ID.unique(), formData);
    const correctPreEvalId = preEvalCollectionIds[productType];
        if (correctPreEvalId) {
          await databases.createDocument(databaseId, correctPreEvalId, mainForm.$id, { status: "draft" });
        }
    await databases.createDocument(databaseId, evalCollectionId, mainForm.$id, { status: "draft" });
    await databases.createDocument(databaseId, postEvalCollectionId, mainForm.$id, { status: "draft" });

    alert("Evaluation form created successfully!");
    document.getElementById("eventForm").reset();
    document.getElementById("locationPreview").classList.remove("active");
    document.getElementById("productCategoryGroup").style.display = "none";
    loadForms();

  } catch (err) {
    console.error("Failed to create form:", err);
    alert("Error creating form");
  }
});

</script>

<footer class="footer">
  <span>¬© 2025 ViTrox. All rights reserved.</span>
</footer>

</body>
</html>




