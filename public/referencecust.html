<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reference Details Management</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="./style.css">
<script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0/dist/iife/sdk.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>

<header class="header">
    <a href="#" class="logo"><img src="logo.png" alt="logo"></a>
    <nav class="nav-desktop">
        <a href="https://docs.google.com/spreadsheets/d/1mxleL8_nFfu6T9RpWAq-7V5K6YX8WRI_d3_uo0bd6Cc/edit?usp=sharing" class="nav-link active" target="_blank">Feedback</a>
        <a href="approveduser.html" class="nav-link">User Management</a>
        <a href="manageform.html" class="nav-link">Manage Forms</a>
        <a href="referencecust.html" class="nav-link active">References Details</a>
        <!-- <a href="reminder.html" class="nav-link">Reminder Email</a>-->
        <a href="#" class="nav-link" id="logoutBtn">Logout</a>
    </nav>
</header>

<main class="main-content-ref">
    <div class="page-header">
        <h1>Reference Details Management</h1>
        <button class="btn-add-category" onclick="openAddCategoryModal()">
            <i class="fas fa-plus-circle"></i> Add New Category
        </button>
    </div>

    <div class="controls-ref">
        <div class="search-box-ref">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Search by category name">
        </div>
    </div>

    <div id="loadingIndicator" class="loading">
        <div class="spinner"></div>
        <p>Loading references</p>
    </div>

    <div id="referenceGrid" class="reference-grid-ref" style="display: none;"></div>
</main>

<!-- Add Category Modal -->
<div id="addCategoryModal" class="modal-ref">
    <div class="modal-overlay-ref" onclick="closeAddCategoryModal()"></div>
    <div class="modal-content-ref">
        <div class="modal-header-ref">
            <h2><i class="fas fa-plus-circle"></i> Add New Category</h2>
            <button class="close-btn" onclick="closeAddCategoryModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="addCategoryForm">
            <div class="form-group-ref">
                <label><i class="fas fa-folder"></i> Category Name</label>
                <input type="text" id="newCategoryName" placeholder="e.g., New Software Category" required>
            </div>
            
            <div class="form-group-ref">
                <label><i class="fas fa-list"></i> Features</label>
                <div id="featuresList" class="feature-list"></div>
                <button type="button" class="btn-add-feature" onclick="addFeatureInput()">
                    <i class="fas fa-plus"></i> Add Feature
                </button>
            </div>

            <div class="modal-actions-ref">
                <button type="button" class="btn-ref btn-cancel-ref" onclick="closeAddCategoryModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="submit" class="btn-ref btn-save-ref">
                    <i class="fas fa-save"></i> Create Category
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Options Modal -->
<div id="editModal" class="modal-ref">
    <div class="modal-overlay-ref" onclick="closeModal()"></div>
    <div class="modal-content-ref">
        <div class="modal-header-ref">
            <h2><i class="fas fa-cog"></i> Manage Options</h2>
            <button class="close-btn" onclick="closeModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="editForm">
            <div class="form-group-ref">
                <label><i class="fas fa-tag"></i> Category - Feature</label>
                <input type="text" id="editTitle" readonly class="readonly-input-ref">
            </div>
            
            <div class="form-group-ref">
                <label><i class="fas fa-plus-circle"></i> Add New Option</label>
                <div class="options-editor-ref">
                    <div class="option-input-row-ref">
                        <input type="text" id="newOptionInput" placeholder="Enter brand (e.g., Dell OptiPlex 7080)">
                        <textarea id="newOptionDesc" placeholder="Enter details for this option"></textarea>
                        <button type="button" class="add-option-btn-ref" onclick="addOption()">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>

                    <div class="current-options-ref">
                        <h4><i class="fas fa-list"></i> Current Options (<span id="optionCount">0</span>)</h4>
                        <div id="optionsList" class="options-list-container-ref">
                            <p class="empty-state-ref">No options added yet</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-actions-ref">
                <button type="button" class="btn-ref btn-cancel-ref" onclick="closeModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="submit" class="btn-ref btn-save-ref">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<script>
const { Client, Account, Databases } = window.Appwrite;
const client = new Client();
client.setEndpoint("https://fra.cloud.appwrite.io/v1").setProject("68ddd7de00255d4f5c96");

const databases = new Databases(client);
const account = new Account(client);
const databaseId = "68ba8a9c001f17064e15";
const referenceCollectionId = "68da1d5f002142be75df";
const categoryCollectionId ="6944b2a20012334309c3";

const categoryFeatures = {
    'V-Library': [
        { id: 'system_gt_32gb_ram', name: 'System >32GB RAM' },
        { id: 'server', name: 'Server' }
    ],
    'AI Programming': [
        { id: 'vayo_accelerator', name: 'Vayo Accelerator' },
        { id: 'mentor_graphics_opm', name: 'Mentor Graphics OPM' }
    ],
    'VVTS': [
        { id: 'vvts_license', name: 'License' },
        { id: 'vvts_pc', name: 'PC' },
        { id: 'vvts_one_aoi', name: 'One AOI to Multiple' }
    ],
    'AI VVTS': [
        { id: 'ai_vvts_license', name: 'License' },
        { id: 'ai_vvts_pc', name: 'PC' },
        { id: 'ai_vvts_one_aoi', name: 'One AOI to Multiple' }
    ],
    'VDSPC 2.0': [
        { id: 'vdspc_license', name: 'License' },
        { id: 'vdspc_server', name: 'Server' }
    ],
    'V-One': [
        { id: 'vone_license', name: 'License' },
        { id: 'vone_server', name: 'Server' }
    ],
    'V-Accelerator': [
        { id: 'v_acc_license', name: 'License / Dongle' }
    ],
    'V-Tune': [
        { id: 'v_tune_system32', name: 'System >32GB RAM' }
    ],
    'Minitab': [
        { id: 'minitab_license', name: 'License' },
        { id: 'minitab_server', name: 'Server' },
        { id: 'minitab_500gb', name: 'Additional >500GB Hard Drive' }
    ],
    'One-View': [
        { id: 'one_view_license', name: 'License' },
        { id: 'one_view_drive_ram', name: 'Additional >500GB Drive, 16GB RAM' }
    ],
    'MES': [
        { id: 'mes_available', name: 'Available Feature' },
        { id: 'mes_develop', name: 'Need to Develop/Enhance' }
    ],
    'Barcode Related': [
        { id: 'barcode_available', name: 'Available Feature' },
        { id: 'barcode_develop', name: 'Need to Develop/Enhance' }
    ]
};

let references = {};
let currentEditId = null;
let currentEditCategory = null;
let currentOptions = [];
let currentDetails = [];
let currentUser = null;
let selectedFeatures = {};
let featureInputCount = 0;

async function loadReferences() {
    try {
        document.getElementById('loadingIndicator').style.display = 'flex';
        document.getElementById('referenceGrid').style.display = 'none';

        currentUser = await account.get();
        console.log('Logged in as:', currentUser.email);

        try {
            const categoryResponse = await databases.listDocuments(databaseId, categoryCollectionId);
            categoryResponse.documents.forEach(doc => {
                const categoryName = doc.categoryName;
                const features = doc.features.map(f => JSON.parse(f));
                categoryFeatures[categoryName] = features;
            });
            console.log('Loaded categories:', Object.keys(categoryFeatures).length);
        } catch (error) {
            console.log('No existing categories found or error loading:', error);
        }

        try {
            const response = await databases.listDocuments(databaseId, referenceCollectionId);
            console.log('Loaded references:', response.documents.length);
            response.documents.forEach(doc => {
                references[doc.referenceId] = {
                    options: doc.options || [],
                    detail: doc.detail || [],
                    category: doc.category || '',
                    docId: doc.$id
                };
            });
        } catch (error) {
            console.log('No existing references found:', error);
        }
        
        Object.keys(categoryFeatures).forEach(category => {
            if (categoryFeatures[category].length > 0) {
                selectedFeatures[category] = categoryFeatures[category][0].id;
            }
        });
        
        displayReferences();
        
        document.getElementById('loadingIndicator').style.display = 'none';
        document.getElementById('referenceGrid').style.display = 'grid';
    } catch (error) {
        console.error('Error loading references:', error);
        showNotification('Error loading references. Please refresh the page.', 'warning');
        window.location.href = 'index.html';
    }
}

function displayReferences(searchFilter = '') {
    const grid = document.getElementById('referenceGrid');
    grid.innerHTML = '';

    const categories = Object.keys(categoryFeatures).filter(category => {
        return !searchFilter || category.toLowerCase().includes(searchFilter.toLowerCase());
    });

    if (categories.length === 0) {
        grid.innerHTML = '<div class="empty-state-ref"><i class="fas fa-inbox"></i><p>No categories found</p></div>';
        return;
    }

    categories.forEach(category => {
        const features = categoryFeatures[category];
        const selectedFeatureId = selectedFeatures[category] || features[0].id;
        const selectedFeature = features.find(f => f.id === selectedFeatureId);
        const refData = references[selectedFeatureId];
        const options = refData ? refData.options : [];
        const details = refData ? refData.detail || [] : [];

        const card = document.createElement('div');
        card.className = 'category-card';
        
        let optionsHtml = '';
        if (options.length > 0) {
            optionsHtml = `<div class="options-list-ref">`;
            options.forEach((option, i) => {
                const name = option || '';
                const desc = details[i] || '';
                optionsHtml += `
                    <div class="option-item-ref">
                        <span class="option-number-ref">${i + 1}.</span>
                        <span class="option-text-ref"><strong>${name}</strong><br><small>${desc}</small></span>
                    </div>
                `;
            });
            optionsHtml += `</div>`;
        } else {
            optionsHtml = '<div class="no-options-ref"><i class="fas fa-inbox"></i><span>No options configured yet</span></div>';
        }

card.innerHTML = `
    <div class="card-header-cat">
        <div class="category-title-row">
            <h3 class="category-title">
                <i class="fas fa-folder-open"></i> ${category}
            </h3>
            <button class="btn-delete-category" onclick="deleteCategory('${category.replace(/'/g, "\\'")}')">
                <i class="fas fa-trash-alt"></i> Delete Category
            </button>
        </div>
        <select class="feature-selector" onchange="changeFeature('${category}', this.value)">
            ${features.map(f => `
                <option value="${f.id}" ${f.id === selectedFeatureId ? 'selected' : ''}>
                    ${f.name}
                </option>
            `).join('')}
        </select>
    </div>
    <div class="card-body-cat">
        <div class="options-display">
            ${optionsHtml}
        </div>
        <div class="action-buttons">
            <button class="btn-ref btn-manage" onclick="openEditModal('${selectedFeatureId}', '${category}', '${selectedFeature.name.replace(/'/g, "\\'")}')">
                <i class="fas fa-cog"></i> Manage Options
            </button>
            <button class="btn-ref btn-delete" onclick="deleteAllOptions('${selectedFeatureId}', '${category}', '${selectedFeature.name.replace(/'/g, "\\'")}')">
                <i class="fas fa-trash-alt"></i> Delete Options
            </button>
        </div>
    </div>
`;
        grid.appendChild(card);
    });
}

function changeFeature(category, featureId) {
    selectedFeatures[category] = featureId;
    displayReferences(document.getElementById('searchInput').value);
}

function openAddCategoryModal() {
    document.getElementById('addCategoryModal').classList.add('active');
    document.body.style.overflow = 'hidden';
    document.getElementById('newCategoryName').value = '';
    document.getElementById('featuresList').innerHTML = '';
    featureInputCount = 0;
    addFeatureInput();
}

function closeAddCategoryModal() {
    document.getElementById('addCategoryModal').classList.remove('active');
    document.body.style.overflow = 'auto';
}

function addFeatureInput() {
    const featuresList = document.getElementById('featuresList');
    const inputGroup = document.createElement('div');
    inputGroup.className = 'feature-input-group';
    inputGroup.id = `feature-${featureInputCount}`;
    inputGroup.innerHTML = `
        <input type="text" placeholder="Feature name (e.g., License)" required>
        <button type="button" class="btn-remove-feature" onclick="removeFeatureInput(${featureInputCount})">
            <i class="fas fa-times"></i>
        </button>
    `;
    featuresList.appendChild(inputGroup);
    featureInputCount++;
}

function removeFeatureInput(id) {
    const element = document.getElementById(`feature-${id}`);
    if (element) {
        element.remove();
    }
}

function deleteCategory(categoryName) {
    if (!confirm(`Are you sure you want to delete the entire "${categoryName}" category?\n\nThis will remove all features and options associated with this category. This action cannot be undone.`)) {
        return;
    }
    delete categoryFeatures[categoryName];
    delete selectedFeatures[categoryName];
    showNotification(`Category "${categoryName}" deleted successfully`, 'success');
    displayReferences(document.getElementById('searchInput').value);
}

async function saveCategoryToDatabase(categoryName, features) {
    try {
        const featureStrings = features.map(f => JSON.stringify(f));
        
        await databases.createDocument(
            databaseId, 
            categoryCollectionId, 
            'unique()', 
            {
                categoryName: categoryName,
                features: featureStrings
            }
        );
        console.log('Category saved to database:', categoryName);
    } catch (error) {
        console.error('Error saving category:', error);
        showNotification('Error saving category to database', 'warning');
    }
}

async function deleteCategoryFromDatabase(categoryName) {
    try {
        const response = await databases.listDocuments(
            databaseId, 
            categoryCollectionId
        );
        const categoryDoc = response.documents.find(doc => doc.categoryName === categoryName);
        if (categoryDoc) {
            await databases.deleteDocument(databaseId, categoryCollectionId, categoryDoc.$id);
            console.log('Category deleted from database:', categoryName);
        }
        
        const featuresToDelete = categoryFeatures[categoryName];
        if (featuresToDelete) {
            for (const feature of featuresToDelete) {
                const refData = references[feature.id];
                if (refData && refData.docId) {
                    await databases.deleteDocument(databaseId, referenceCollectionId, refData.docId);
                    delete references[feature.id];
                }
            }
        }
    } catch (error) {
        console.error('Error deleting category from database:', error);
        throw error;
    }
}

document.getElementById('addCategoryForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const categoryName = document.getElementById('newCategoryName').value.trim();
    
    if (!categoryName) {
        showNotification('Please enter a category name', 'warning');
        return;
    }
    
    if (categoryFeatures[categoryName]) {
        showNotification('Category already exists', 'warning');
        return;
    }

    const featureInputs = document.querySelectorAll('#featuresList .feature-input-group input');
    const features = [];
    
    featureInputs.forEach((input, index) => {
        const featureName = input.value.trim();
        if (featureName) {
            const featureId = `${categoryName.toLowerCase().replace(/\s+/g, '_')}_${featureName.toLowerCase().replace(/\s+/g, '_')}_${Date.now()}_${index}`;
            features.push({
                id: featureId,
                name: featureName
            });
        }
    });
    
    if (features.length === 0) {
        showNotification('Please add at least one feature', 'warning');
        return;
    }

    categoryFeatures[categoryName] = features;
    selectedFeatures[categoryName] = features[0].id;
    await saveCategoryToDatabase(categoryName, features);
    
    closeAddCategoryModal();
    displayReferences(document.getElementById('searchInput').value);
    showNotification(`Category "${categoryName}" created successfully!`, 'success');
});

async function deleteCategory(categoryName) {
    if (!confirm(`Are you sure you want to delete the entire "${categoryName}" category?\n\nThis will remove all features and options associated with this category. This action cannot be undone.`)) {
        return;
    }
    
    try {
        await deleteCategoryFromDatabase(categoryName);
        delete categoryFeatures[categoryName];
        delete selectedFeatures[categoryName];
        
        showNotification(`Category "${categoryName}" deleted successfully`, 'success');
        displayReferences(document.getElementById('searchInput').value);
    } catch (error) {
        console.error('Error deleting category:', error);
        showNotification('Error deleting category: ' + error.message, 'warning');
    }
}

function openEditModal(id, category, name) {
    currentEditId = id;
    currentEditCategory = category;
    const refData = references[id];
    currentOptions = refData ? [...refData.options] : [];
    currentDetails = refData ? [...refData.detail] : [];
    
    document.getElementById('editTitle').value = `${category} - ${name}`;
    document.getElementById('newOptionInput').value = '';
    document.getElementById('newOptionDesc').value = '';
    updateOptionsList();
    
    document.getElementById('editModal').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function updateOptionsList() {
    const optionsList = document.getElementById('optionsList');
    const optionCount = document.getElementById('optionCount');
    
    optionCount.textContent = currentOptions.length;

    if (currentOptions.length === 0) {
        optionsList.innerHTML = '<p class="empty-state-ref">No options added yet</p>';
        return;
    }

    optionsList.innerHTML = '';
    currentOptions.forEach((opt, i) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'modal-option-item-ref';
        optionDiv.innerHTML = `
            <div class="option-number-ref">${i + 1}</div>
            <span class="option-text-ref"><strong>${opt}</strong> - ${currentDetails[i] || ''}</span>
            <button type="button" class="delete-option-btn-ref" onclick="removeOption(${i})" title="Delete option">
                <i class="fas fa-trash-alt"></i>
            </button>
        `;
        optionsList.appendChild(optionDiv);
    });
}

async function saveOptionsToDatabase() {
    try {
        const refData = references[currentEditId];
        const docId = refData ? refData.docId : null;

        const data = {
            referenceId: currentEditId,
            category: currentEditCategory,
            options: currentOptions, 
            detail: currentDetails,   
            username: currentUser.name || currentUser.email
        };

        let updatedDoc;
        if (docId) {
            updatedDoc = await databases.updateDocument(databaseId, referenceCollectionId, docId, data);
        } else {
            updatedDoc = await databases.createDocument(databaseId, referenceCollectionId, 'unique()', data);
        }

        references[currentEditId] = {
            options: currentOptions,
            detail: currentDetails,
            category: currentEditCategory,
            docId: updatedDoc.$id
        };

        displayReferences(document.getElementById('searchInput').value);
    } catch (error) {
        console.error("Error saving options:", error);
        showNotification("Error saving options: " + error.message, "warning");
    }
}

function addOption() {
    const nameInput = document.getElementById('newOptionInput');
    const descInput = document.getElementById('newOptionDesc');

    const name = nameInput.value.trim();
    const desc = descInput.value.trim();

    if (!name) {
        showNotification('Please enter a brand name', 'warning');
        return;
    }

    if (currentOptions.includes(name)) {
        showNotification('This option already exists', 'warning');
        return;
    }

    currentOptions.push(name);
    currentDetails.push(desc || "");

    nameInput.value = '';
    descInput.value = '';

    updateOptionsList();
    saveOptionsToDatabase();
    showNotification('Option added successfully', 'success');
}

async function removeOption(index) {
    if (confirm('Are you sure you want to remove this option?')) {
        currentOptions.splice(index, 1);
        currentDetails.splice(index, 1);
        updateOptionsList();
        await saveOptionsToDatabase();
        showNotification('Option removed', 'info');
    }
}

async function deleteAllOptions(id, category, name) {
    if (!confirm(`Are you sure you want to delete ALL options for "${category} - ${name}"?\n\nThis action cannot be undone.`)) {
        return;
    }
    
    try {
        const refData = references[id];
        if (refData && refData.docId) {
            await databases.deleteDocument(databaseId, referenceCollectionId, refData.docId);
            delete references[id];
            currentOptions = [];
            currentDetails = [];
            showNotification('All options deleted successfully', 'success');
        } else {
            showNotification('No options to delete', 'info');
        }
        displayReferences(document.getElementById('searchInput').value);
    } catch (error) {
        console.error('Error deleting options:', error);
        showNotification('Error deleting options: ' + error.message, 'warning');
    }
}

function closeModal() {
    document.getElementById('editModal').classList.remove('active');
    document.body.style.overflow = 'auto';
    currentEditId = null;
    currentEditCategory = null;
    currentOptions = [];
    currentDetails = [];
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification-ref ${type}`;
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
        <span>${message}</span>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => notification.classList.add('show'), 10);
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

document.getElementById('editForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (currentOptions.length === 0) {
        showNotification('Please add at least one option', 'warning');
        return;
    }
    await saveOptionsToDatabase();
    closeModal();
    showNotification('Options updated successfully!', 'success');
});

document.getElementById('searchInput').addEventListener('input', (e) => {
    displayReferences(e.target.value);
});

document.getElementById('newOptionInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        addOption();
    }
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && document.getElementById('editModal').classList.contains('active')) {
        closeModal();
    }
});

async function logout() {
    try { 
        await account.deleteSession("current");
        console.log('Logged out successfully');
        window.location.href = "index.html"; 
    } catch (err) { 
        console.error("Logout failed:", err); 
        window.location.href = "index.html"; 
    }
}

document.getElementById("logoutBtn").addEventListener("click", (e) => {
    e.preventDefault();
    logout();
});
loadReferences();
</script>
    
<footer class="footer">
    <span>Â© 2025 ViTrox. All rights reserved.</span>
</footer>
</body>
</html>






