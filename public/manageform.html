<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Manage Forms</title>
<link rel="stylesheet" href="./style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0/dist/iife/sdk.js"></script>
</head>
<body>

<header class="header">
    <a href="#" class="logo"><img src="logo.png" alt="logo"></a>
    <nav class="nav-desktop">
        <a href="approveduser.html" class="nav-link">User Management</a>
        <a href="manageform.html" class="nav-link active">Manage Forms</a>
        <a href="referencecust.html" class="nav-link">References Details</a>
        <a href="#" class="nav-link" id="logoutBtn">Logout</a>
    </nav>
</header>

<main class="form-wrapper">
    <div class="controls">
        <!-- Product Type Filter -->
        <select id="typeFilter" onchange="applyFilters()">
            <option value="All">All Types</option>
            <option value="SPI">SPI</option>
            <option value="AOI">AOI</option>
            <option value="ARV">ARV</option>
            <option value="AXI">AXI</option>
            <option value="XC">Smart Camera (XC)</option>
            <option value="XS">Smart Code Reader (XS)</option>
        </select>
        <label>From: <input type="date" id="startDate" onchange="applyFilters()"></label>
        <label>To: <input type="date" id="endDate" onchange="applyFilters()"></label>
    </div>
    <table id="formsTable">
      <thead>
        <tr>
          <th rowspan="2">Username</th>
          <th rowspan="2">Type</th>
          <th colspan="3">Status</th>
          <th rowspan="2">Created On</th>
          <th rowspan="2">Actions</th>
        </tr>
        <tr>
          <th>Pre-Evaluation</th>
          <th>Evaluation</th>
          <th>Post-Evaluation</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
</main>

<div id="editModal" class="modal" style="display: none;">
  <div class="modal-content small">
    <div class="modal-header">
      <h3 id="editTitle">Edit Form</h3>
      <button class="close-btn" onclick="closeEditModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="editForm">
        <div class="form-group">
          <label>Type</label>
          <select id="editType">
            <option value="SPI">SPI</option>
            <option value="AOI">AOI</option>
            <option value="ARV">ARV</option>
            <option value="AXI">AXI</option>
            <option value="XC">Smart Camera (XC)</option>
            <option value="XS">Smart Code Reader (XS)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Pre-Evaluation</label>
          <select id="editPreEvalStatus">
            <option value="draft">Draft</option>
            <option value="progress">In Progress</option>
            <option value="complete">Complete</option>
          </select>
        </div>
        <div class="form-group">
          <label>Evaluation</label>
          <select id="editEvalStatus">
            <option value="draft">Draft</option>
            <option value="progress">In Progress</option>
            <option value="complete">Complete</option>
          </select>
        </div>
        <div class="form-group">
          <label>Post-Evaluation</label>
          <select id="editPostEvalStatus">
            <option value="draft">Draft</option>
            <option value="progress">In Progress</option>
            <option value="complete">Complete</option>
          </select>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveFormChanges()">Save</button>
    </div>
  </div>
</div>

<script>
const { Client, Account, Databases, Query } = window.Appwrite;
const client = new Client();
client.setEndpoint("https://fra.cloud.appwrite.io/v1")
.setProject("68ddd7de00255d4f5c96");

const account = new Account(client);
const databases = new Databases(client);

const databaseId = "68ba8a9c001f17064e15";
const collectionId = "68ba918c0022d2b9a429";
const preEvalCollectionId = "68c7ced6001bd14d08f4";
const evalCollectionId = "68bf9d5600257a20775a";
const postEvalCollectionId = "68bf9d62002b4f5f7f23";

let forms = [];
let editingFormId = null;

async function checkSession() {
    try {
        const user = await account.get();
        console.log('Logged in as:', user.email);
    } catch (err) {
        console.error('No active session:', err);
        window.location.href = 'index.html';
    }
}

async function getFormStatus(collectionId, formId) {
  try {
    const doc = await databases.getDocument(databaseId, collectionId, formId);
    return doc.status || "draft";
  } catch (err) {
    console.log(`No document found for ${formId} in collection ${collectionId}`);
    return "draft";
  }
}

async function loadForms() {
  try {
    const res = await databases.listDocuments(databaseId, collectionId, [Query.limit(100)]);
    console.log('Loaded forms:', res.documents.length);

    forms = await Promise.all(res.documents.map(async (doc) => {
      return {
        id: doc.$id,
        username: doc.username || doc.$createdBy || "Unknown",
        type: doc.productType || "",
        pre_eval: await getFormStatus(preEvalCollectionId, doc.$id),
        eval: await getFormStatus(evalCollectionId, doc.$id),
        post_eval: await getFormStatus(postEvalCollectionId, doc.$id),
        createdOn: doc.createDate || doc.$createdAt,
        isArchived: doc.isArchived || false
      };
    }));
    
    forms = forms.filter(f => !f.isArchived);
    console.log('Active forms after filtering:', forms.length);
    applyFilters();
  } catch (err) {
    console.error("Error loading forms:", err);
    alert("Failed to load forms from database: " + err.message);
  }
}

function applyFilters() {
  const typeFilter = document.getElementById("typeFilter").value;
  const startDate = document.getElementById("startDate").value ? new Date(document.getElementById("startDate").value) : null;
  const endDate = document.getElementById("endDate").value ? new Date(document.getElementById("endDate").value) : null;

  let filtered = forms;

  if (typeFilter !== "All") {
    filtered = filtered.filter(f => f.type === typeFilter);
  }
  
  if (startDate) {
    filtered = filtered.filter(f => new Date(f.createdOn) >= startDate);
  }
  
  if (endDate) {
    endDate.setHours(23, 59, 59, 999);
    filtered = filtered.filter(f => new Date(f.createdOn) <= endDate);
  }

  console.log('Filtered forms:', filtered.length);
  renderTable(filtered);
}

function renderTable(data) {
  const tbody = document.querySelector("#formsTable tbody");
  tbody.innerHTML = "";

  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 20px;">No forms found</td></tr>`;
    return;
  }

  data.forEach(form => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${form.username}</td>
      <td>${form.type}</td>
      <td><span class="status-badge ${form.pre_eval}">${getStatusText(form.pre_eval)}</span></td>
      <td><span class="status-badge ${form.eval}">${getStatusText(form.eval)}</span></td>
      <td><span class="status-badge ${form.post_eval}">${getStatusText(form.post_eval)}</span></td>
      <td>${formatDate(form.createdOn)}</td>
      <td>
        <div class="action-buttons">
          <button class="edit" onclick="editForm('${form.id}')" title="Edit Form"><i class="fas fa-edit"></i></button>
          <button class="archive" onclick="archiveForm('${form.id}')" title="Archive Form"><i class="fas fa-box-archive"></i></button>
        </div>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function getStatusText(status) {
  switch (status) {
    case 'draft': return 'Draft';
    case 'progress': return 'In Progress';
    case 'complete': return 'Complete';
    default: return '-';
  }
}

function editForm(formId) {
  const form = forms.find(f => f.id === formId);
  if (!form) return;

  editingFormId = formId;
  document.getElementById("editType").value = form.type;
  document.getElementById("editPreEvalStatus").value = form.pre_eval;
  document.getElementById("editEvalStatus").value = form.eval;
  document.getElementById("editPostEvalStatus").value = form.post_eval;
  document.getElementById("editTitle").textContent = "Edit Form - " + form.type;
  document.getElementById("editModal").style.display = "flex";
}

async function saveFormChanges() {
  if (!editingFormId) return;

  const newType = document.getElementById("editType").value;
  const newPre = document.getElementById("editPreEvalStatus").value;
  const newEval = document.getElementById("editEvalStatus").value;
  const newPost = document.getElementById("editPostEvalStatus").value;

  try {
    await databases.updateDocument(databaseId, collectionId, editingFormId, { 
      productType: newType 
    });
    const statusUpdates = [];

    try {
      await databases.updateDocument(databaseId, preEvalCollectionId, editingFormId, { status: newPre });
    } catch (err) {
      console.log('Pre-eval document not found, skipping');
    }

    try {
      await databases.updateDocument(databaseId, evalCollectionId, editingFormId, { status: newEval });
    } catch (err) {
      console.log('Eval document not found, skipping');
    }

    try {
      await databases.updateDocument(databaseId, postEvalCollectionId, editingFormId, { status: newPost });
    } catch (err) {
      console.log('Post-eval document not found, skipping');
    }

    const form = forms.find(f => f.id === editingFormId);
    if (form) {
      form.type = newType;
      form.pre_eval = newPre;
      form.eval = newEval;
      form.post_eval = newPost;
    }

    applyFilters();
    closeEditModal();
    alert("Form updated successfully!");
  } catch (err) {
    console.error("Update failed:", err);
    alert("Failed to update form: " + err.message);
  }
}

async function archiveForm(formId) {
  if (!confirm("Are you sure you want to archive this form? It will no longer appear in the active list.")) return;

  try {
    await databases.updateDocument(databaseId, collectionId, formId, {
      isArchived: true
    });
    const archivePromises = [
      databases.updateDocument(databaseId, preEvalCollectionId, formId, { isArchived: true }).catch(() => {}),
      databases.updateDocument(databaseId, evalCollectionId, formId, { isArchived: true }).catch(() => {}),
      databases.updateDocument(databaseId, postEvalCollectionId, formId, { isArchived: true }).catch(() => {})
    ];

    await Promise.allSettled(archivePromises);

    forms = forms.filter(f => f.id !== formId);
    applyFilters();
    alert("Form archived successfully!");
  } catch (err) {
    console.error("Archive failed:", err);
    alert(`Failed to archive form: ${err.message}`);
  }
}

function closeEditModal() {
  document.getElementById("editModal").style.display = "none";
  editingFormId = null;
}

function formatDate(dateStr) {
  return new Date(dateStr).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}

async function logout() {
  try {
    await account.deleteSession("current");
    console.log('Logged out successfully');
    window.location.href = "index.html";
  } catch (err) {
    console.error("Logout failed:", err);
    window.location.href = "index.html";
  }
}
document.getElementById("logoutBtn").addEventListener("click", (e) => {
  e.preventDefault();
  logout();
});

window.onclick = function(event) {
  const modal = document.getElementById('editModal');
  if (event.target === modal) {
    closeEditModal();
  }
};

document.addEventListener("DOMContentLoaded", async () => {
  await checkSession();
  await loadForms();
});
</script>

<footer class="footer-regis">
    <span>© 2025 ViTrox. All rights reserved.</span>
</footer>

</body>

</html>
