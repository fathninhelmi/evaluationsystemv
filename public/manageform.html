<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Manage Forms</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="./style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0/dist/iife/sdk.js"></script>
</head>
<body>

<header class="header">
    <a href="#" class="logo"><img src="logo.png" alt="logo"></a>
    <nav class="nav-desktop">
        <a href="approveduser.html" class="nav-link">User Management</a>
        <a href="manageform.html" class="nav-link active">Manage Forms</a>
        <a href="referencecust.html" class="nav-link">References Details</a>
        <a href="library.html" class="nav-link">Library</a>
        <!-- <a href="reminder.html" class="nav-link">Reminder Email</a>-->
        <a href="#" class="nav-link" id="logoutBtn">Logout</a>
    </nav>
</header>

<main class="form-wrapper">
    <div class="controls">
        <select id="typeFilter" onchange="updateCategoryFilter(); applyFilters()">
            <option value="All">All Types</option>
            <option value="SPI">SPI</option>
            <option value="AOI">AOI</option>
            <option value="ARV">ARV</option>
            <option value="AXI">AXI</option>
            <option value="XC">Smart Camera (XC)</option>
            <option value="XS">Smart Code Reader (XS)</option>
        </select>
        <select id="categoryFilter" onchange="applyFilters()" style="display: none;">
            <option value="All">All Categories</option>
        </select>
        <label>From: <input type="date" id="startDate" onchange="applyFilters()"></label>
        <label>To: <input type="date" id="endDate" onchange="applyFilters()"></label>
    </div>
    <table id="formsTable">
      <thead>
        <tr>
          <th rowspan="2">Username</th>
          <th rowspan="2">Type</th>
          <th rowspan="2">Category</th>
          <th colspan="3">Status & Actions</th>
          <th rowspan="2">Created On</th>
          <th rowspan="2">Archive</th>
        </tr>
        <tr>
          <th>Pre-Evaluation</th>
          <th>Evaluation</th>
          <th>Post-Evaluation</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
</main>

<script>
const { Client, Account, Databases, Query } = window.Appwrite;
const client = new Client();
client.setEndpoint("https://fra.cloud.appwrite.io/v1")
.setProject("68ddd7de00255d4f5c96");

const account = new Account(client);
const databases = new Databases(client);

const databaseId = "68ba8a9c001f17064e15";
const collectionId = "68ba918c0022d2b9a429";
const preEvalCollectionId = "68c7ced6001bd14d08f4";
const evalCollectionId = "68bf9d5600257a20775a";
const postEvalCollectionId = "68bf9d62002b4f5f7f23";

let forms = [];

const productCategoryOptions = {
  'SPI': [
    { value: 'semiconspi', label: 'Back-end Semiconductor' },
    { value: 'smtspi', label: 'SMT PCB Assembly' }
  ],
  'AOI': [
    { value: 'semiconaoi', label: 'Back-end Semiconductor' },
    { value: 'smtaoi', label: 'SMT PCB Assembly' },
    { value: 'finalAssembly', label: 'Final Assembly' }
  ],
  'AXI': [
    { value: 'highspeed', label: 'High-Speed' },
    { value: 'highresolution', label: 'High-Resolution' }
  ],
  'ARV': [
    { value: 'speedinline', label: 'High Speed Inline System' },
    { value: 'flexibilityoffline', label: 'High Flexibility Offline System' }
  ]
};

function getCategoryLabel(type, value) {
  if (!type || !value || !productCategoryOptions[type]) return '-';
  const option = productCategoryOptions[type].find(opt => opt.value === value);
  return option ? option.label : value;
}

function editForm(formId) {
  const form = forms.find(f => f.id === formId);
  if (!form) return;
  const productTypeLower = (form.type || '').toLowerCase().trim();
  let preEvalPage;
  
  switch (productTypeLower) {
    case "xs":
    case "smart code reader (xs)":
      preEvalPage = `preevalXS.html?id=${formId}`;
      break;
    case "xc":
    case "smart camera (xc)":
      preEvalPage = `preevalXC.html?id=${formId}`;
      break;
    default:
      preEvalPage = `preeval.html?id=${formId}`;
  }
  window.location.href = preEvalPage;
}

async function checkSession() {
    try {
        const user = await account.get();
        console.log('Logged in as:', user.email);
    } catch (err) {
        console.error('No active session:', err);
        window.location.href = 'index.html';
    }
}

async function getFormStatus(collectionId, formId) {
  try {
    const doc = await databases.getDocument(databaseId, collectionId, formId);
    return doc.status || "draft";
  } catch (err) {
    console.log(`No document found for ${formId} in collection ${collectionId}`);
    return "draft";
  }
}

async function loadForms() {
  try {
    const res = await databases.listDocuments(databaseId, collectionId, [Query.limit(100)]);
    console.log('Loaded forms:', res.documents.length);

    forms = await Promise.all(res.documents.map(async (doc) => {
      return {
        id: doc.$id,
        username: doc.username || doc.$createdBy || "Unknown",
        type: doc.productType || "",
        category: doc.productCategory || "",
        pre_eval: await getFormStatus(preEvalCollectionId, doc.$id),
        eval: await getFormStatus(evalCollectionId, doc.$id),
        post_eval: await getFormStatus(postEvalCollectionId, doc.$id),
        createdOn: doc.createDate || doc.$createdAt,
        isArchived: doc.isArchived || false
      };
    }));
    
    forms = forms.filter(f => !f.isArchived);
    console.log('Active forms after filtering:', forms.length);
    applyFilters();
  } catch (err) {
    console.error("Error loading forms:", err);
    alert("Failed to load forms from database: " + err.message);
  }
}

function updateCategoryFilter() {
  const typeFilter = document.getElementById("typeFilter").value;
  const categoryFilter = document.getElementById("categoryFilter");
  
  if (typeFilter !== "All" && productCategoryOptions[typeFilter]) {
    categoryFilter.style.display = "inline-block";
    categoryFilter.innerHTML = '<option value="All">All Categories</option>';
    
    productCategoryOptions[typeFilter].forEach(option => {
      const optionEl = document.createElement("option");
      optionEl.value = option.value;
      optionEl.textContent = option.label;
      categoryFilter.appendChild(optionEl);
    });
  } else {
    categoryFilter.style.display = "none";
    categoryFilter.value = "All";
  }
}

function applyFilters() {
  const typeFilter = document.getElementById("typeFilter").value;
  const categoryFilter = document.getElementById("categoryFilter").value;
  const startDate = document.getElementById("startDate").value ? new Date(document.getElementById("startDate").value) : null;
  const endDate = document.getElementById("endDate").value ? new Date(document.getElementById("endDate").value) : null;

  let filtered = forms;

  if (typeFilter !== "All") {
    filtered = filtered.filter(f => f.type === typeFilter);
  }
  
  if (categoryFilter !== "All") {
    filtered = filtered.filter(f => f.category === categoryFilter);
  }
  
  if (startDate) {
    filtered = filtered.filter(f => new Date(f.createdOn) >= startDate);
  }
  
  if (endDate) {
    endDate.setHours(23, 59, 59, 999);
    filtered = filtered.filter(f => new Date(f.createdOn) <= endDate);
  }

  console.log('Filtered forms:', filtered.length);
  renderTable(filtered);
}

function renderTable(data) {
  const tbody = document.querySelector("#formsTable tbody");
  tbody.innerHTML = "";

  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 20px;">No forms found</td></tr>`;
    return;
  }

  data.forEach(form => {
    const preEvalLink = getPreEvalPage(form.type, form.id);
    const evalLink = `eval.html?id=${form.id}`;
    const postEvalLink = `posteval.html?id=${form.id}`;
    
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${form.username}</td>
      <td>${form.type}</td>
      <td>${getCategoryLabel(form.type, form.category)}</td>
      <td>
        <span class="status-badge ${form.pre_eval}">${getStatusText(form.pre_eval)}</span><br>
        ${getEditButton(form.pre_eval, preEvalLink)}
      </td>
      <td>
        <span class="status-badge ${form.eval}">${getStatusText(form.eval)}</span><br>
        ${getEditButton(form.eval, evalLink)}
      </td>
      <td>
        <span class="status-badge ${form.post_eval}">${getStatusText(form.post_eval)}</span><br>
        ${getEditButton(form.post_eval, postEvalLink)}
      </td>
      <td>${formatDate(form.createdOn)}</td>
      <td>
        <div class="action-buttons">
          <button class="archive" onclick="archiveForm('${form.id}')" title="Archive Form"><i class="fas fa-box-archive"></i></button>
        </div>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function getStatusText(status) {
  switch (status) {
    case 'draft': return 'Draft';
    case 'progress': return 'In Progress';
    case 'complete': return 'Complete';
    case 'drop': return 'Drop';
    default: return '-';
  }
}

function getPreEvalPage(productType, docId) {
  if (!productType) return `preeval.html?id=${docId}`;
  
  const productTypeLower = productType.toLowerCase().trim();
  
  switch (productTypeLower) {
    case "xs":
    case "smart code reader (xs)":
      return `preevalXS.html?id=${docId}`;
    case "xc":
    case "smart camera (xc)":
      return `preevalXC.html?id=${docId}`;
    default:
      return `preeval.html?id=${docId}`;
  }
}

function getEditButton(status, link) {
  if (status === "complete" || status === "draft" || status === "progress" || status === "drop") {
    return `<a href="${link}" class="open-btn enabled" title="Edit">Edit</a>`;
  }
  return `<a href="#" class="open-btn disabled" title="Not available">Edit</a>`;
}

async function archiveForm(formId) {
  if (!confirm("Are you sure you want to archive this form? It will no longer appear in the active list.")) return;

  try {
    await databases.updateDocument(databaseId, collectionId, formId, {
      isArchived: true
    });
    const archivePromises = [
      databases.updateDocument(databaseId, preEvalCollectionId, formId, { isArchived: true }).catch(() => {}),
      databases.updateDocument(databaseId, evalCollectionId, formId, { isArchived: true }).catch(() => {}),
      databases.updateDocument(databaseId, postEvalCollectionId, formId, { isArchived: true }).catch(() => {})
    ];

    await Promise.allSettled(archivePromises);

    forms = forms.filter(f => f.id !== formId);
    applyFilters();
    alert("Form archived successfully!");
  } catch (err) {
    console.error("Archive failed:", err);
    alert(`Failed to archive form: ${err.message}`);
  }
}

function formatDate(dateStr) {
  return new Date(dateStr).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}

async function logout() {
  try {
    await account.deleteSession("current");
    console.log('Logged out successfully');
    window.location.href = "index.html";
  } catch (err) {
    console.error("Logout failed:", err);
    window.location.href = "index.html";
  }
}
document.getElementById("logoutBtn").addEventListener("click", (e) => {
  e.preventDefault();
  logout();
});
    
document.addEventListener("DOMContentLoaded", async () => {
  await checkSession();
  await loadForms();
});
</script>

<footer class="footer-regis">
    <span>Â© 2025 ViTrox. All rights reserved.</span>
</footer>
</body>
</html>





